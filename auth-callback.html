<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - EmailSortPro</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        .callback-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 3rem;
            border: 1px solid rgba(255, 255, 255, 0.25);
            max-width: 550px;
            width: 90%;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .message-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .error-details {
            background: rgba(255, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
            text-align: left;
            word-break: break-all;
        }
        .debug-info {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.8em;
            text-align: left;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }
    </style>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
    <div class="callback-container">
        <div id="loading-state" style="display: block;">
            <div class="spinner"></div>
            <h1>Authentification en cours...</h1>
            <p>Veuillez patienter pendant que nous vérifions vos informations.</p>
        </div>

        <div id="success-state" style="display: none;">
            <div class="message-icon">✅</div>
            <h1>Authentification Réussie !</h1>
            <p>Vous allez être redirigé(e) vers l'application.</p>
        </div>

        <div id="error-state" style="display: none;">
            <div class="message-icon">❌</div>
            <h1>Erreur d'Authentification</h1>
            <p id="error-message">Une erreur inconnue est survenue.</p>
            <div class="error-details" id="error-details"></div>
            <p>Veuillez réessayer ou contacter le support.</p>
            <button onclick="window.location.href='https://emailsortpro.netlify.app/'" style="margin-top: 20px; padding: 10px 20px; border: none; border-radius: 5px; background-color: #764ba2; color: white; cursor: pointer;">Retour à l'accueil</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            clientId: '436941729211-00tc5fdl74l0hc3q1qotfknh0v86h72i.apps.googleusercontent.com',
            redirectUri: 'https://emailsortpro.netlify.app/auth-callback.html',
            scopes: [
                'https://www.googleapis.com/auth/userinfo.email',
                'https://www.googleapis.com/auth/userinfo.profile',
                'https://www.googleapis.com/auth/gmail.modify'
            ].join(' '),
            environment: 'development',
            basePath: 'https://emailsortpro.netlify.app',
            apiEndpoint: 'https://api.emailsortpro.com'
        };
        window.AppConfig = CONFIG;
    </script>
    
    <script src="js/utils/localStorageManager.js"></script>

    <script>
        // Fonction pour obtenir les paramètres d'URL
        function getQueryParams() {
            const params = {};
            window.location.search.substring(1).split('&').forEach(param => {
                const parts = param.split('=');
                params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
            });
            return params;
        }

        // Fonction pour afficher l'état
        function showState(stateId) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('success-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'none';
            document.getElementById(stateId).style.display = 'block';
        }

        // Fonction pour gérer la réponse OAuth
        function handleOAuthResponse() {
            const params = getQueryParams();
            console.log('[Auth Callback] URL Parameters:', params);

            if (params.code) {
                // Un code d'autorisation a été reçu
                console.log('[Auth Callback] Code received:', params.code.substring(0, 20) + '...');
                
                // Utiliser la fonction du SDK Google pour échanger le code contre un jeton
                // Le initCodeClient est appelé ici avec un callback. Quand le code est dans l'URL,
                // le GSI le détecte et exécute le callback directement avec la réponse du jeton.
                const client = google.accounts.oauth2.initCodeClient({
                    client_id: AppConfig.clientId,
                    scope: AppConfig.scopes,
                    redirect_uri: AppConfig.redirectUri,
                    callback: (tokenResponse) => { // Ce callback est appelé APRES l'échange du code par GSI
                        console.log('[Auth Callback] Token Response:', tokenResponse);
                        if (tokenResponse.error) {
                            showErrorState('Échange de jeton échoué', tokenResponse.error + ': ' + tokenResponse.error_description);
                        } else if (tokenResponse.access_token) {
                            // Échange réussi, nous avons un access_token
                            console.log('[Auth Callback] Access Token received. Fetching user info...');
                            // Maintenant, nous devons récupérer les informations de l'utilisateur avec ce jeton
                            fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                                headers: {
                                    'Authorization': `Bearer ${tokenResponse.access_token}`
                                }
                            })
                            .then(response => response.json())
                            .then(profile => {
                                console.log('[Auth Callback] User Profile:', profile);
                                if (profile.email) {
                                    // Stocker les données d'authentification et de profil
                                    localStorageManager.setAuthData({
                                        accessToken: tokenResponse.access_token,
                                        refreshToken: tokenResponse.refresh_token, // Le refresh token peut ne pas être renvoyé pour les flux client-side sans PKCE
                                        expiresIn: tokenResponse.expires_in,
                                        issuedAt: Date.now(), 
                                        profile: {
                                            id: profile.sub,
                                            name: profile.name,
                                            email: profile.email,
                                            picture: profile.picture
                                        }
                                    });
                                    showState('success-state');
                                    // Rediriger vers la page principale après un court délai
                                    setTimeout(() => {
                                        window.location.href = AppConfig.basePath + '#dashboard';
                                    }, 1500);
                                } else {
                                    showErrorState('Impossible de récupérer le profil utilisateur.', JSON.stringify(profile));
                                }
                            })
                            .catch(error => {
                                console.error('[Auth Callback] Error fetching user profile:', error);
                                showErrorState('Erreur lors de la récupération du profil utilisateur', error.message || error);
                            });
                        } else {
                            showErrorState('Réponse de jeton inattendue.', JSON.stringify(tokenResponse));
                        }
                    }
                });
                // Note: requestCode() n'est pas appelé ici car on gère une réponse entrante, pas une nouvelle requête.
            } else if (params.error) {
                // Une erreur a été signalée par Google
                showErrorState(`Accès refusé ou erreur: ${params.error}`, params.error_description || 'Pas de description fournie.');
            } else {
                // Ni code ni erreur dans l'URL - situation inattendue
                showErrorState('URL de rappel invalide', 'Aucun paramètre "code" ou "error" trouvé.');
            }
        }

        // Fonction pour afficher l'état d'erreur
        function showErrorState(message, details = '') {
            showState('error-state');
            document.getElementById('error-message').innerText = message;
            document.getElementById('error-details').innerText = details;
            console.error('Authentication Error:', message, details);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // S'assurer que la bibliothèque GSI est chargée avant d'appeler initCodeClient
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                handleOAuthResponse();
            } else {
                // Si la lib n'est pas encore chargée (par exemple si async defer est lent), on attend
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.onload = () => {
                    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                        handleOAuthResponse();
                    } else {
                        showErrorState('Erreur de chargement', 'La bibliothèque Google Sign-In n\'a pas pu être chargée correctement.');
                    }
                };
                script.onerror = () => {
                    showErrorState('Erreur réseau', 'Impossible de charger la bibliothèque Google Sign-In depuis accounts.google.com.');
                };
                document.head.appendChild(script);
            }
        });

        // Fonctions de diagnostic existantes, à conserver
        function getClientId() { return AppConfig.clientId; }

        window.authCallbackDebug = function() {
            console.group('Auth Callback Debug Info');
            console.log('AppConfig:', AppConfig);
            console.log('Environment:', AppConfig.environment);
            console.log('Current URL:', window.location.href);
            console.log('Client ID:', getClientId().substring(0, 8) + '...');
            console.log('Base path:', AppConfig.basePath);
            console.log('Google loaded:', typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 ? 'OK' : 'MANQUANT');
            console.log('LocalStorage available:', typeof Storage !== 'undefined');
            console.log('User agent:', navigator.userAgent);
            
            try {
                const testKey = 'test_' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                console.log('LocalStorage: ✅ Functional');
            } catch (e) {
                console.log('LocalStorage: ❌ Error -', e.message);
            }
            
            console.log('DOM states:', {
                loading: document.getElementById('loading-state').style.display !== 'none',
                success: document.getElementById('success-state').style.display !== 'none',
                error: document.getElementById('error-state').style.display !== 'none'
            });
            
            console.groupEnd();
        };
        
        console.log('[Auth Callback] ✅ Enhanced callback page ready with improved error handling');
        console.log('[Auth Callback] Use authCallbackDebug() for detailed diagnostic information');
    </script>
</body>
</html>
