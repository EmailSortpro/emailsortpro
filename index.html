<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmailSortProAI - Scanner d'Emails Intelligent avec IA</title>
    
    <meta name="description" content="Organisez vos emails Outlook intelligemment avec l'IA. Cat√©gorie automatique et organisation par domaine.">
    <meta name="keywords" content="email, outlook, microsoft, gestion, ia, productivit√©, organisation">
    <meta name="author" content="VH - Vianney Hastings">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://emailsortpro.netlify.app/">
    <meta property="og:title" content="EmailSortProAI - Scanner d'Emails Intelligent">
    <meta property="og:description" content="Organisez vos emails Outlook intelligemment avec l'IA.">
    
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://emailsortpro.netlify.app/">
    <meta property="twitter:title" content="EmailSortProAI - Scanner d'Emails Intelligent">
    <meta property="twitter:description" content="Organisez vos emails Outlook intelligemment avec l'IA.">
    
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìß</text></svg>">
    
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/email-scan.css">
    <link rel="stylesheet" href="css/task-view.css">
    <link rel="stylesheet" href="css/category-view.css">
    <link rel="stylesheet" href="css/onboarding.css">
    <link rel="stylesheet" href="css/auth-status.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <img src="assets/logo.png" alt="EmailSortProAI Logo">
                <h1>EmailSortProAI</h1>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="#dashboard" class="nav-item active" data-page="dashboard"><i class="icon-dashboard"></i> Tableau de Bord</a></li>
                    <li><a href="#scan-email" class="nav-item" data-page="scan-email"><i class="icon-scan"></i> Scanner Emails</a></li>
                    <li><a href="#tasks" class="nav-item" data-page="tasks"><i class="icon-tasks"></i> T√¢ches</a></li>
                    <li><a href="#categories" class="nav-item" data-page="categories"><i class="icon-categories"></i> Cat√©gories</a></li>
                    <li><a href="#settings" class="nav-item" data-page="settings"><i class="icon-settings"></i> Param√®tres</a></li>
                </ul>
            </nav>
            <div class="auth-status" id="auth-status">
                <button id="google-sign-in-button" class="google-sign-in-button">
                    <img src="assets/google-logo.svg" alt="Google logo" class="google-logo">
                    Se connecter avec Google
                </button>
            </div>
        </aside>

        <main class="main-content" id="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
                    <h2 id="page-title">Tableau de Bord</h2>
                </div>
                <div class="header-right">
                    <input type="text" placeholder="Rechercher..." class="search-bar">
                    <button class="icon-button"><i class="icon-bell"></i></button>
                    <div class="user-profile">
                        <img src="assets/user-avatar.png" alt="User Avatar" class="user-avatar">
                    </div>
                </div>
            </header>

            <div id="page-content">
                </div>
        </main>
    </div>

    <div id="onboarding-modal" class="modal">
        <div class="modal-content">
            <h2>Bienvenue sur EmailSortProAI !</h2>
            <p>Organisez vos e-mails sans effort gr√¢ce √† notre scanner intelligent aliment√© par l'IA.</p>
            <button id="start-onboarding-button">Commencer</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            clientId: '436941729211-00tc5fdl74l0hc3q1qotfknh0v86h72i.apps.googleusercontent.com',
            redirectUri: 'https://emailsortpro.netlify.app/auth-callback.html',
            // Scopes n√©cessaires pour la lecture, modification (cr√©ation/d√©placement de dossiers) et le profil utilisateur
            scopes: [
                'https://www.googleapis.com/auth/userinfo.email',
                'https://www.googleapis.com/auth/userinfo.profile',
                'https://www.googleapis.com/auth/gmail.modify' 
            ].join(' '),
            environment: 'development', 
            basePath: 'https://emailsortpro.netlify.app',
            apiEndpoint: 'https://api.emailsortpro.com' // Exemple, √† ajuster si vous avez un backend
        };

        window.AppConfig = CONFIG; // Rendre la configuration accessible globalement
    </script>

    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <script src="js/utils/localStorageManager.js"></script>
    <script src="js/services/authService.js"></script> 
    <script src="js/services/mailService.js"></script>
    <script src="js/utils/uiManager.js"></script>
    <script src="js/utils/pageManager.js"></script>
    <script src="js/modules/dashboard.js"></script>
    <script src="js/modules/emailScan.js"></script>
    <script src="js/modules/taskManager.js"></script>
    <script src="js/modules/tasksView.js"></script>
    <script src="js/modules/categoryManager.js"></script>
    <script src="js/modules/onboarding.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const googleSignInButton = document.getElementById('google-sign-in-button');
            
            if (googleSignInButton) {
                googleSignInButton.onclick = () => {
                    handleGoogleSignIn();
                };
            }

            // Fonction pour g√©rer la connexion Google
            window.handleGoogleSignIn = () => {
                console.log("[index.html] Initiating Google Sign-In...");
                if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                    console.error("[index.html] Google Identity Services library not loaded.");
                    alert("Erreur: La biblioth√®que Google Identity Services n'est pas charg√©e. Veuillez r√©essayer.");
                    return;
                }

                const client = google.accounts.oauth2.initCodeClient({
                    client_id: AppConfig.clientId,
                    scope: AppConfig.scopes,
                    ux_mode: 'redirect', // Important: utilise la redirection vers auth-callback.html
                    redirect_uri: AppConfig.redirectUri,
                    // Note: Le callback ici n'est pas utilis√© avec ux_mode: 'redirect'.
                    // La page de redirection (auth-callback.html) g√©rera la r√©ponse.
                    callback: (response) => {
                        console.log("[index.html] Callback from initCodeClient (should not be called for redirect mode):", response);
                    }
                });
                client.requestCode(); // D√©clenche la redirection vers Google
            };

            // Fonction pour v√©rifier et mettre √† jour l'√©tat d'authentification
            function checkAuthStatus() {
                const authStatusDiv = document.getElementById('auth-status');
                const authData = localStorageManager.getAuthData(); // Utilise le nouveau localStorageManager

                if (authData && authData.accessToken && authData.profile) {
                    console.log("[index.html] User is authenticated.");
                    updateAuthStatusUI(authData.profile);
                } else {
                    console.log("[index.html] User is not authenticated. Showing sign-in button.");
                    // Assure que le bouton de connexion est visible si non connect√©
                    authStatusDiv.innerHTML = `
                        <button id="google-sign-in-button" class="google-sign-in-button">
                            <img src="assets/google-logo.svg" alt="Google logo" class="google-logo">
                            Se connecter avec Google
                        </button>
                    `;
                    // R√©attacher l'√©couteur d'√©v√©nements apr√®s avoir recr√©√© le bouton
                    document.getElementById('google-sign-in-button').onclick = () => {
                        handleGoogleSignIn();
                    };
                }
            }
            window.checkAuthStatus = checkAuthStatus; // Rendre accessible globalement

            // Fonction pour mettre √† jour l'interface utilisateur avec les infos de l'utilisateur
            function updateAuthStatusUI(profile) {
                const authStatus = document.getElementById('auth-status');
                const userName = profile.name || profile.email;
                const userEmail = profile.email;
                const initials = (profile.name || userEmail).split(' ').map(n => n[0]).join('').toUpperCase();
                
                authStatus.innerHTML = `
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name">${userName}</div>
                            <div class="user-email">${userEmail}</div>
                        </div>
                        <div class="user-avatar">${initials}</div>
                    </div>
                    <button id="google-sign-out-button" class="google-sign-out-button">D√©connexion</button>
                `;

                // Attacher le gestionnaire de d√©connexion
                document.getElementById('google-sign-out-button').onclick = () => {
                    console.log("[index.html] User signing out.");
                    localStorageManager.clearAuthData(); // Supprime les donn√©es d'auth
                    checkAuthStatus(); // Met √† jour l'UI pour afficher le bouton de connexion
                    alert('Vous avez √©t√© d√©connect√©.');
                    // Optionnel: rediriger ou recharger la page si n√©cessaire
                    // window.location.reload(); 
                };
            }

            // Initialisation au chargement du DOM
            checkAuthStatus(); // V√©rifie l'√©tat d'auth au d√©marrage
            uiManager.init();
            pageManager.init();
            dashboardModule.init();
            emailScanModule.init();
            taskManager.init();
            tasksView.init();
            categoryManager.init();
            onboarding.init();
        });

        // Fonction de diagnostic accessible globalement (silencieuse par d√©faut)
        window.checkServices = function() {
            return {
                AppConfig: window.AppConfig ? 'OK' : 'MANQUANT',
                authService: window.authService ? 'OK' : 'MANQUANT',
                mailService: window.mailService ? 'OK' : 'MANQUANT',
                uiManager: window.uiManager ? 'OK' : 'MANQUANT',
                taskManager: window.taskManager ? (window.taskManager.initialized ? 'OK (initialized)' : 'LOADING') : 'MANQUANT',
                tasksView: window.tasksView ? 'OK' : 'MANQUANT',
                pageManager: window.pageManager ? 'OK' : 'MANQUANT',
                categoryManager: window.categoryManager ? 'OK' : 'MANQUANT',\
                dashboardModule: window.dashboardModule ? 'OK' : 'MANQUANT',\
                hostname: window.location.hostname,\
                expectedHostname: 'emailsortpro.netlify.app'\
            };
        };
    </script>
</body>
</html>
