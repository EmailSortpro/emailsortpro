<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modal Original Corrig√©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
        }

        .demo-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .demo-buttons {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .demo-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .demo-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .demo-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .demo-btn.danger {
            background: #ef4444;
            color: white;
        }

        .status {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 13px;
        }

        /* =============================================
           VOTRE DESIGN ORIGINAL - EXACTEMENT IDENTIQUE
           ============================================= */
        .authorization-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .authorization-modal-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .authorization-modal {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .authorization-modal-overlay.visible .authorization-modal {
            transform: scale(1);
        }

        .auth-modal-header {
            padding: 24px;
            text-align: center;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            color: white;
        }

        .auth-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 24px;
        }

        .auth-modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        .auth-modal-header p {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
        }

        .auth-modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .auth-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .feature-icon {
            width: 36px;
            height: 36px;
            background: #3B82F6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
        }

        .auth-feature:nth-child(2) .feature-icon {
            background: #10b981;
        }

        .auth-feature:nth-child(3) .feature-icon {
            background: #f59e0b;
        }

        .feature-text {
            flex: 1;
        }

        .feature-text strong {
            display: block;
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .feature-text span {
            font-size: 13px;
            color: #6b7280;
        }

        .auth-path-preview {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .path-label {
            font-size: 12px;
            color: #374151;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .path-value {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: monospace;
            font-size: 13px;
            color: #0369a1;
            font-weight: 600;
        }

        .auth-promise {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #166534;
            margin-top: 20px;
        }

        .auth-modal-actions {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .auth-btn {
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
            border: none;
        }

        .auth-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .auth-btn.secondary:hover {
            background: #e5e7eb;
        }

        .auth-btn.primary {
            background: #3B82F6;
            color: white;
        }

        .auth-btn.primary:hover {
            background: #2563eb;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .authorization-modal {
                margin: 16px;
                max-width: none;
            }

            .auth-modal-header, .auth-modal-body {
                padding: 20px;
            }

            .auth-modal-actions {
                padding: 16px 20px;
                flex-direction: column;
            }

            .auth-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>üîß Modal Original Corrig√©</h1>
        <p>Votre design et texte exacts, mais avec un syst√®me simple qui fonctionne vraiment.</p>

        <div class="demo-buttons">
            <button class="demo-btn primary" onclick="showOriginalModal()">
                <i class="fas fa-rocket"></i> Afficher le Modal Original
            </button>
            <button class="demo-btn secondary" onclick="checkModalStatus()">
                <i class="fas fa-info"></i> V√©rifier Statut
            </button>
            <button class="demo-btn danger" onclick="resetModalSystem()">
                <i class="fas fa-trash"></i> Reset pour Test
            </button>
        </div>

        <div id="modalStatus" class="status">
            Statut : Pr√™t pour test
        </div>

        <h2>üìã Code d'int√©gration simplifi√©</h2>
        <pre style="background: #f8fafc; padding: 15px; border-radius: 6px; font-size: 12px; overflow-x: auto;">
// √Ä AJOUTER dans votre showApp() ou apr√®s connexion r√©ussie :
if (window.isFirstConnectionEver && window.isFirstConnectionEver()) {
    setTimeout(() => {
        window.showFirstConnectionModal();
    }, 2000);
}
        </pre>

        <h3>‚úÖ Modifications apport√©es :</h3>
        <ul>
            <li><strong>Gard√© 100% de votre design original</strong></li>
            <li><strong>Gard√© 100% de votre texte original</strong></li>
            <li><strong>Simplifi√© la logique de d√©tection</strong></li>
            <li><strong>√âlimin√© les conflits entre fonctions</strong></li>
            <li><strong>Syst√®me robuste qui fonctionne vraiment</strong></li>
        </ul>
    </div>

    <!-- VOTRE MODAL ORIGINAL - DESIGN ET TEXTE EXACTS -->
    <div id="originalAuthModal" class="authorization-modal-overlay">
        <div class="authorization-modal">
            <div class="auth-modal-header">
                <div class="auth-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2>Autorisation de Sauvegarde</h2>
                <p>EmailSortPro souhaite cr√©er son dossier de sauvegarde</p>
            </div>
            
            <div class="auth-modal-body">
                <div class="auth-explanation">
                    <div class="auth-feature">
                        <div class="feature-icon">
                            <i class="fas fa-folder-plus"></i>
                        </div>
                        <div class="feature-text">
                            <strong>Cr√©ation automatique</strong>
                            <span>Un dossier EmailSortPro sera cr√©√© dans vos Documents</span>
                        </div>
                    </div>
                    
                    <div class="auth-feature">
                        <div class="feature-icon">
                            <i class="fas fa-save"></i>
                        </div>
                        <div class="feature-text">
                            <strong>Sauvegarde s√©curis√©e</strong>
                            <span>Vos cat√©gories et param√®tres seront sauvegard√©s automatiquement</span>
                        </div>
                    </div>
                    
                    <div class="auth-feature">
                        <div class="feature-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div class="feature-text">
                            <strong>Confidentialit√© garantie</strong>
                            <span>Tous vos fichiers restent sur votre ordinateur</span>
                        </div>
                    </div>
                </div>
                
                <div class="auth-path-preview">
                    <div class="path-label">Emplacement de cr√©ation :</div>
                    <div class="path-value">
                        <i class="fas fa-folder"></i>
                        Documents\EmailSortPro\Categories\
                    </div>
                </div>
                
                <div class="auth-promise">
                    <i class="fas fa-check-circle"></i>
                    Cette autorisation ne vous sera demand√©e qu'une seule fois
                </div>
            </div>
            
            <div class="auth-modal-actions">
                <button class="auth-btn secondary" onclick="declineOriginalModal()">
                    <i class="fas fa-times"></i>
                    Plus tard
                </button>
                <button class="auth-btn primary" onclick="acceptOriginalModal()">
                    <i class="fas fa-check"></i>
                    Autoriser la cr√©ation
                </button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // SYST√àME SIMPLE ET ROBUSTE - FONCTIONNE VRAIMENT
        // =============================================

        // 1. D√âTECTION PREMI√àRE CONNEXION SIMPLE
        window.isFirstConnectionEver = function() {
            try {
                // Les 3 √©tats possibles : modal montr√©, autoris√©, ou refus√©
                const modalShown = localStorage.getItem('emailsortpro_backup_modal_shown');
                const authorized = localStorage.getItem('emailsortpro_filesystem_authorized');
                const declined = localStorage.getItem('emailsortpro_backup_declined');
                
                // Si aucun de ces 3 √©tats n'existe, c'est la premi√®re fois
                const isFirst = !modalShown && !authorized && !declined;
                
                console.log('[FIRST_CHECK]', {
                    modalShown: !!modalShown,
                    authorized: !!authorized,
                    declined: !!declined,
                    isFirstConnection: isFirst
                });
                
                return isFirst;
            } catch (error) {
                console.warn('[FIRST_CHECK] Error:', error);
                return true; // En cas d'erreur, consid√©rer comme premi√®re fois
            }
        };

        // 2. AFFICHAGE MODAL SIMPLE
        window.showFirstConnectionModal = function() {
            console.log('[MODAL] üöÄ Tentative d\'affichage du modal...');
            
            // V√©rification STRICTE
            if (!window.isFirstConnectionEver()) {
                console.log('[MODAL] ‚ùå Pas la premi√®re connexion, modal bloqu√©');
                return false;
            }
            
            console.log('[MODAL] ‚úÖ Premi√®re connexion confirm√©e, affichage du modal');
            
            // Marquer IMM√âDIATEMENT que le modal a √©t√© montr√©
            try {
                localStorage.setItem('emailsortpro_backup_modal_shown', 'true');
                localStorage.setItem('emailsortpro_backup_modal_date', new Date().toISOString());
            } catch (error) {
                console.warn('[MODAL] Could not save modal state:', error);
            }
            
            // Afficher le modal avec votre design original
            const modal = document.getElementById('originalAuthModal');
            modal.classList.add('visible');
            
            // Emp√™cher le scroll
            document.body.style.overflow = 'hidden';
            
            console.log('[MODAL] ‚úÖ Modal affich√© avec succ√®s !');
            return true;
        };

        // 3. ACCEPTATION
        window.acceptOriginalModal = function() {
            console.log('[MODAL] ‚úÖ Utilisateur a ACCEPT√â l\'autorisation');
            
            try {
                localStorage.setItem('emailsortpro_filesystem_authorized', 'true');
                localStorage.setItem('emailsortpro_authorization_date', new Date().toISOString());
            } catch (error) {
                console.warn('[MODAL] Could not save authorization:', error);
            }
            
            // Fermer le modal
            closeOriginalModal();
            
            // Toast de confirmation
            showSimpleToast('‚úÖ Autorisation accord√©e! Configuration disponible dans les Param√®tres.', 'success');
            
            // ICI : D√©clencher la cr√©ation du dossier ou la configuration
            if (window.categoriesPageV24?.configureDirectAccess) {
                setTimeout(() => {
                    window.categoriesPageV24.configureDirectAccess();
                }, 1000);
            }
        };

        // 4. REFUS
        window.declineOriginalModal = function() {
            console.log('[MODAL] ‚ùå Utilisateur a REFUS√â l\'autorisation');
            
            try {
                localStorage.setItem('emailsortpro_backup_declined', 'true');
                localStorage.setItem('emailsortpro_backup_decline_date', new Date().toISOString());
            } catch (error) {
                console.warn('[MODAL] Could not save decline:', error);
            }
            
            // Fermer le modal
            closeOriginalModal();
            
            // Toast informatif
            showSimpleToast('üìÅ Sauvegarde disponible dans les Param√®tres quand vous le souhaitez.', 'info');
        };

        // 5. FERMETURE MODAL
        function closeOriginalModal() {
            const modal = document.getElementById('originalAuthModal');
            modal.classList.remove('visible');
            document.body.style.overflow = '';
        }

        // 6. TOAST SIMPLE
        function showSimpleToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                z-index: 100000;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // =============================================
        // FONCTIONS DE D√âMONSTRATION
        // =============================================

        function showOriginalModal() {
            window.showFirstConnectionModal();
        }

        function checkModalStatus() {
            const status = {
                isFirst: window.isFirstConnectionEver(),
                modalShown: localStorage.getItem('emailsortpro_backup_modal_shown') === 'true',
                authorized: localStorage.getItem('emailsortpro_filesystem_authorized') === 'true',
                declined: localStorage.getItem('emailsortpro_backup_declined') === 'true',
                modalDate: localStorage.getItem('emailsortpro_backup_modal_date'),
                authDate: localStorage.getItem('emailsortpro_authorization_date'),
                declineDate: localStorage.getItem('emailsortpro_backup_decline_date')
            };
            
            const statusText = `Statut du syst√®me :
- Premi√®re connexion : ${status.isFirst ? 'OUI ‚úÖ' : 'NON ‚ùå'}
- Modal d√©j√† affich√© : ${status.modalShown ? 'OUI' : 'NON'}
- Utilisateur a autoris√© : ${status.authorized ? 'OUI ‚úÖ' : 'NON'}
- Utilisateur a refus√© : ${status.declined ? 'OUI ‚ùå' : 'NON'}
- Date modal : ${status.modalDate || 'Jamais'}
- Date autorisation : ${status.authDate || 'Jamais'}
- Date refus : ${status.declineDate || 'Jamais'}`;
            
            document.getElementById('modalStatus').textContent = statusText;
        }

        function resetModalSystem() {
            const keys = [
                'emailsortpro_backup_modal_shown',
                'emailsortpro_filesystem_authorized', 
                'emailsortpro_backup_declined',
                'emailsortpro_backup_modal_date',
                'emailsortpro_authorization_date',
                'emailsortpro_backup_decline_date'
            ];
            
            keys.forEach(key => {
                try {
                    localStorage.removeItem(key);
                } catch (error) {
                    console.warn('Could not remove:', key);
                }
            });
            
            document.getElementById('modalStatus').textContent = 'üîÑ Syst√®me reset - Modal peut √™tre affich√© √† nouveau';
            showSimpleToast('üîÑ Reset effectu√© ! Le modal peut maintenant s\'afficher.', 'info');
        }

        // Fermer le modal si clic en dehors
        document.getElementById('originalAuthModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOriginalModal();
            }
        });

        // CSS d'animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        console.log('‚úÖ Syst√®me modal original corrig√© charg√© !');
        console.log('üéØ Pour int√©grer : appelez window.showFirstConnectionModal() apr√®s connexion');
    </script>
</body>
</html>
