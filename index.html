<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmailSortProAI - Scanner d'Emails Intelligent avec IA</title>
    
    <meta name="description" content="Organisez vos emails Outlook intelligemment avec l'IA. Cat√©gorisation automatique et organisation par domaine.">
    <meta name="keywords" content="email, outlook, microsoft, gestion, ia, productivit√©, organisation">
    <meta name="author" content="VH - Vianney Hastings">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://emailsortpro.netlify.app/">
    <meta property="og:title" content="EmailSortProAI - Scanner d'Emails Intelligent">
    <meta property="og:description" content="Organisez vos emails Outlook intelligemment avec l'IA.">
    
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://emailsortpro.netlify.app/">
    <meta property="twitter:title" content="EmailSortProAI - Scanner d'Emails Intelligent">
    <meta property="twitter:description" content="Organisez vos emails Outlook intelligemment avec l'IA.">
    
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìß</text></svg>">

    <link rel="stylesheet" href="style.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <script src="https://alcdn.msauth.net/browser/2.30.0/msal-browser.min.js"></script>
    
    <script src="https://apis.google.com/js/api.js"></script>

    <script src="config.js"></script>

</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo">
                <h1>EmailSortProAI</h1>
                <p>Scanner d'Emails Intelligent</p>
            </div>
            <nav class="main-nav">
                <ul>
                    <li data-page="dashboard" class="active"><a href="#"><i class="fas fa-tachometer-alt"></i> Tableau de Bord</a></li>
                    <li data-page="inbox"><a href="#"><i class="fas fa-inbox"></i> Bo√Æte de R√©ception</a></li>
                    <li data-page="sent"><a href="#"><i class="fas fa-paper-plane"></i> √âl√©ments Envoy√©s</a></li>
                    <li data-page="drafts"><a href="#"><i class="fas fa-file-alt"></i> Brouillons</a></li>
                    <li data-page="archive"><a href="#"><i class="fas fa-archive"></i> Archives</a></li>
                    <li data-page="junk"><a href="#"><i class="fas fa-trash"></i> Courrier Ind√©sirable</a></li>
                    <li data-page="settings"><a href="#"><i class="fas fa-cog"></i> Param√®tres</a></li>
                    <li data-page="help"><a href="#"><i class="fas fa-question-circle"></i> Aide</a></li>
                </ul>
            </nav>
            <div id="authStatus" class="auth-status">
                <p>Non connect√©.</p>
            </div>
            <div class="auth-buttons">
                <button id="outlookLoginButton" class="btn btn-primary btn-block">Se connecter √† Outlook</button>
                <button id="gmailLoginButton" class="btn btn-primary btn-block">Se connecter √† Gmail</button>
                <button id="logoutButton" class="btn btn-secondary btn-block" style="display: none;">D√©connexion</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="search-bar">
                    <input type="text" placeholder="Rechercher des emails..." class="search-input">
                    <button class="btn btn-search"><i class="fas fa-search"></i></button>
                </div>
                <div class="user-profile">
                    <span id="headerUserDisplayName">Guest</span>
                    <i class="fas fa-user-circle"></i>
                </div>
            </header>

            <section id="dashboardPage" class="page-content active">
                <h2>Tableau de Bord</h2>
                <div class="dashboard-widgets">
                    <div class="widget">Statistiques d'Emails</div>
                    <div class="widget">Cat√©gories Principales</div>
                </div>
            </section>

            <section id="inboxPage" class="page-content">
                <h2>Bo√Æte de R√©ception</h2>
                <div class="email-list" id="inboxEmailList">
                    </div>
            </section>
            
            <section id="sentPage" class="page-content">
                <h2>√âl√©ments Envoy√©s</h2>
                <div class="email-list" id="sentEmailList"></div>
            </section>

            <section id="draftsPage" class="page-content">
                <h2>Brouillons</h2>
                <div class="email-list" id="draftsEmailList"></div>
            </section>

            <section id="archivePage" class="page-content">
                <h2>Archives</h2>
                <div class="email-list" id="archiveEmailList"></div>
            </section>

            <section id="junkPage" class="page-content">
                <h2>Courrier Ind√©sirable</h2>
                <div class="email-list" id="junkEmailList"></div>
            </section>

            <section id="settingsPage" class="page-content">
                <h2>Param√®tres</h2>
                <p>G√©rez vos pr√©f√©rences ici.</p>
            </section>

            <section id="helpPage" class="page-content">
                <h2>Aide</h2>
                <p>Trouvez de l'aide et des informations sur l'application.</p>
            </section>

        </main>
    </div>

    <script src="AuthService.js"></script>
    <script src="MailService.js"></script>
    <script>
        // Global utility function to update authentication status in UI
        window.updateAuthStatusUI = function(userName, userEmail, provider = null) {
            const authStatus = document.getElementById('authStatus');
            const outlookLoginButton = document.getElementById('outlookLoginButton');
            const gmailLoginButton = document.getElementById('gmailLoginButton');
            const logoutButton = document.getElementById('logoutButton');
            const headerUserDisplayName = document.getElementById('headerUserDisplayName');

            if (userName && userEmail) {
                const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                authStatus.innerHTML = `
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name">${userName}</div>
                            <div class="user-email">${userEmail}</div>
                        </div>
                        <div class="user-avatar">${initials}</div>
                    </div>
                    <p>Connect√© via ${provider || 'inconnu'}</p>
                `;
                outlookLoginButton.style.display = 'none';
                gmailLoginButton.style.display = 'none';
                logoutButton.style.display = 'block';
                headerUserDisplayName.textContent = userName;
            } else {
                authStatus.innerHTML = '<p>Non connect√©.</p>';
                outlookLoginButton.style.display = 'block';
                gmailLoginButton.style.display = 'block';
                logoutButton.style.display = 'none';
                headerUserDisplayName.textContent = 'Guest';
            }
        };

        // Event Listeners for login/logout buttons
        document.getElementById('outlookLoginButton').addEventListener('click', async () => {
            if (window.authService) {
                try {
                    await window.authService.login('outlook');
                    const account = window.authService.getAccount();
                    if (account) {
                        window.updateAuthStatusUI(account.name, account.username, 'Outlook');
                        // Initialize MailService for Outlook
                        if (window.mailService) {
                            await window.mailService.initialize('outlook');
                            console.log('MailService initialized for Outlook.');
                        }
                    }
                } catch (error) {
                    console.error('Outlook login failed:', error);
                    alert('√âchec de la connexion Outlook. V√©rifiez la console pour plus de d√©tails.');
                }
            } else {
                console.error('AuthService not available.');
            }
        });

        document.getElementById('gmailLoginButton').addEventListener('click', async () => {
            if (window.authService) {
                try {
                    await window.authService.login('gmail');
                    const account = window.authService.getAccount(); // This will return Google user info
                    if (account) {
                        window.updateAuthStatusUI(account.name, account.email, 'Gmail');
                        // Initialize MailService for Gmail
                        if (window.mailService) {
                            await window.mailService.initialize('gmail');
                            console.log('MailService initialized for Gmail.');
                        }
                    }
                } catch (error) {
                    console.error('Gmail login failed:', error);
                    alert('√âchec de la connexion Gmail. V√©rifiez la console pour plus de d√©tails.');
                }
            } else {
                console.error('AuthService not available.');
            }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            if (window.authService) {
                await window.authService.logout();
                window.updateAuthStatusUI(null, null); // Clear UI
                // Potentially reset MailService or set it to an uninitialized state
                if (window.mailService) {
                    window.mailService.reset(); // A new method to reset MailService state
                }
                alert('D√©connect√©.');
            } else {
                console.error('AuthService not available.');
            }
        });

        // Initial check on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Ensure AuthService is initialized before checking authentication
            if (window.authService) {
                await window.authService.waitForConfig(); // Wait for config to be ready
                await window.authService.initializeMsal(); // Ensure MSAL is initialized for silent login attempts
                await window.authService.initializeGapi(); // Ensure GAPI is initialized

                // Check for authenticated user from either provider
                let account = null;
                let provider = null;

                if (window.authService.isAuthenticated('outlook')) {
                    account = window.authService.getAccount('outlook');
                    provider = 'Outlook';
                } else if (window.authService.isAuthenticated('gmail')) {
                    account = window.authService.getAccount('gmail');
                    provider = 'Gmail';
                }

                if (account) {
                    window.updateAuthStatusUI(account.name, account.email || account.username, provider);
                     // Initialize MailService based on detected provider
                    if (window.mailService) {
                        await window.mailService.initialize(provider.toLowerCase());
                        console.log(`MailService initialized for ${provider}.`);
                    }
                } else {
                    window.updateAuthStatusUI(null, null);
                }
            }
        });


        // Fonction de diagnostic accessible globalement (silencieuse par d√©faut)
        window.checkServices = function() {
            return {
                AppConfig: window.AppConfig ? 'OK' : 'MANQUANT',
                authService: window.authService ? 'OK' : 'MANQUANT',
                mailService: window.mailService ? (window.mailService.isInitialized ? 'OK (initialized)' : 'LOADING') : 'MANQUANT',
                uiManager: typeof window.uiManager !== 'undefined' ? 'OK' : 'MANQUANT', // Assuming UIManager is present
                taskManager: typeof window.taskManager !== 'undefined' ? (window.taskManager.initialized ? 'OK (initialized)' : 'LOADING') : 'MANQUANT', // Assuming TaskManager
                tasksView: typeof window.tasksView !== 'undefined' ? 'OK' : 'MANQUANT', // Assuming TasksView
                pageManager: typeof window.pageManager !== 'undefined' ? 'OK' : 'MANQUANT', // Assuming PageManager
                categoryManager: typeof window.categoryManager !== 'undefined' ? 'OK' : 'MANQUANT', // Assuming CategoryManager
                dashboardModule: typeof window.dashboardModule !== 'undefined' ? 'OK' : 'MANQUANT', // Assuming DashboardModule
                hostname: window.location.hostname,
                expectedHostname: 'emailsortpro.netlify.app'
            };
        };
    </script>
</body>
</html>
