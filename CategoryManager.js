// CategoryManager.js - Version 27.1 - SYNTAXE CORRIG√âE

class CategoryManager {
    constructor() {
        console.log('[CategoryManager] üöÄ Constructor starting v27.1...');
        
        this.categories = {};
        this.keywordCatalog = {};
        this.customCategories = {};
        this.settings = this.loadSettings();
        this.isInitialized = false;
        this.debugMode = false;
        
        // Syst√®me de synchronisation
        this.changeListeners = new Set();
        
        // Gestion des scans
        this.scanHistory = [];
        this.lastScanResults = null;
        this.scanProviders = {
            gmail: {
                name: 'Gmail',
                icon: 'fab fa-google',
                color: '#ea4335',
                priority: 1,
                methods: ['mailService', 'directGmail', 'googleAuthService']
            },
            outlook: {
                name: 'Outlook',
                icon: 'fab fa-microsoft', 
                color: '#0078d4',
                priority: 2,
                methods: ['mailService', 'directOutlook', 'authService']
            }
        };
        
        // Initialisation synchrone des composants critiques
        try {
            this.initializeCategories();
            this.loadCustomCategories();
            this.initializeKeywordCatalog();
            this.setupEventListeners();
            
            this.isInitialized = true;
            console.log('[CategoryManager] ‚úÖ Version 27.1 - Initialized successfully');
            
            // Notifier que CategoryManager est pr√™t
            this.notifyReady();
            
        } catch (error) {
            console.error('[CategoryManager] ‚ùå Initialization error:', error);
            this.isInitialized = false;
        }
    }

    // ================================================
    // NOTIFICATION DE DISPONIBILIT√â
    // ================================================
    notifyReady() {
        console.log('[CategoryManager] üì¢ Notifying that CategoryManager is ready');
        
        try {
            window.dispatchEvent(new CustomEvent('categoryManagerReady', {
                detail: {
                    isInitialized: this.isInitialized,
                    categoriesCount: Object.keys(this.categories).length,
                    version: '27.1'
                }
            }));
            console.log('[CategoryManager] ‚úÖ Ready event dispatched');
        } catch (error) {
            console.error('[CategoryManager] Error dispatching ready event:', error);
        }
        
        window.categoryManagerReady = true;
    }

    // ================================================
    // CATALOGUE DE MOTS-CL√âS - SANS DOUBLONS
    // ================================================
    initializeKeywordCatalog() {
        console.log('[CategoryManager] üîç Initialisation catalogue v27.1 - Mots-cl√©s uniques par cat√©gorie...');
        
        this.keywordCatalog = {
            // MARKETING & NEWSLETTER - Mots-cl√©s uniques
            marketing_news: {
                absolute: [
                    // D√©sabonnement (unique √† marketing)
                    'se d√©sabonner', 'se desinscrire', 'd√©sinscrire', 'desinscrire',
                    'unsubscribe', 'opt out', 'opt-out', 'd√©sabonner', 'desabonner',
                    'g√©rer vos pr√©f√©rences', 'g√©rer la r√©ception', 'g√©rer mes pr√©f√©rences',
                    'email preferences', 'pr√©f√©rences email', 'preferences email',
                    'ne plus recevoir', 'stop emails', 'arreter les emails', 'arr√™ter les emails',
                    
                    // Newsletter (unique √† marketing)
                    'newsletter', 'newsletter hebdomadaire', 'newsletter mensuelle',
                    'mailing list', 'mailing', 'e-mailing', 'emailing',
                    'liste de diffusion', 'diffusion email', 'email marketing',
                    'campagne email', 'email campaign', 'mass email', 'email blast',
                    
                    // Visualisation web (unique √† marketing)
                    'view in browser', 'voir dans le navigateur', 'version web',
                    'having trouble viewing', 'probl√®me d\'affichage',
                    
                    // Plateformes marketing (unique √† marketing)
                    'mailchimp', 'sendgrid', 'mailgun', 'constant contact',
                    'aweber', 'getresponse', 'campaign monitor', 'sendinblue',
                    
                    // Adresses automatiques (unique √† marketing)
                    'noreply@', 'no-reply@', 'donotreply@', 'do-not-reply@',
                    'automated message', 'message automatique',
                    'this is an automated', 'ceci est un message automatis√©'
                ],
                strong: [
                    // Commerce (unique √† marketing)
                    'publicity', 'publicit√©', 'advertising', 'campaign', 'campagne',
                    'promotion', 'promo', 'deal', 'offer', 'offre', 'sale', 'vente',
                    'discount', 'r√©duction', 'special', 'exclusive', 'limited',
                    'new arrivals', 'nouveaut√©s', 'collection', 'catalog', 'catalogue',
                    
                    // Actions marketing (unique √† marketing)
                    'shop', 'boutique', 'store', 'magasin', 'shopping',
                    'acheter', 'buy', 'purchase', 'order', 'commander',
                    'cart', 'panier', 'checkout'
                ],
                weak: [
                    'discover', 'd√©couvrir', 'explore', 'explorer',
                    'learn more', 'en savoir plus', 'read more',
                    'visit', 'visiter', 'click here', 'cliquez ici'
                ],
                exclusions: []
            },

            // S√âCURIT√â - Mots-cl√©s uniques
            security: {
                absolute: [
                    // Alertes connexion (unique √† s√©curit√©)
                    'alerte de connexion', 'alert connexion', 'nouvelle connexion',
                    'new sign-in', 'sign in detected', 'connexion d√©tect√©e',
                    'login alert', 'alerte login', 'connexion inhabituelle',
                    
                    // Activit√© suspecte (unique √† s√©curit√©)
                    'activit√© suspecte', 'suspicious activity', 'activit√© inhabituelle',
                    'unusual activity', 'unauthorized access', 'acc√®s non autoris√©',
                    'compte compromis', 'account compromised', 'security breach',
                    
                    // Codes et v√©rification (unique √† s√©curit√©)
                    'code de v√©rification', 'verification code', 'security code',
                    'code de s√©curit√©', 'two-factor', '2fa', 'authentification √† deux facteurs',
                    
                    // R√©initialisation (unique √† s√©curit√©)
                    'password reset', 'r√©initialisation mot de passe',
                    'reset your password', 'r√©initialiser votre mot de passe',
                    'confirm your identity', 'confirmez votre identit√©'
                ],
                strong: [
                    // Termes s√©curit√© (unique √† s√©curit√©)
                    's√©curit√©', 'security', 'v√©rification', 'verify',
                    'authentification', 'authentication', 'password', 'mot de passe',
                    'login', 'connexion', 'access', 'acc√®s', 'breach', 'violation',
                    'protect', 'prot√©ger', 'secure', 's√©curiser', 'alert', 'alerte'
                ],
                weak: [
                    'identity', 'identit√©', 'privacy', 'confidentialit√©',
                    'protection', 'user', 'utilisateur'
                ],
                exclusions: []
            },

            // T√ÇCHES - Mots-cl√©s uniques + TAGS
            tasks: {
                absolute: [
                    // Actions requises (unique √† t√¢ches)
                    'action required', 'action requise', 'action needed',
                    'action n√©cessaire', 'action demand√©e', 'action attendue',
                    
                    // Compl√©tion (unique √† t√¢ches)
                    'please complete', 'veuillez compl√©ter', '√† compl√©ter',
                    'complete by', '√† compl√©ter avant', 'finish by',
                    
                    // Assignation (unique √† t√¢ches)
                    'task assigned', 't√¢che assign√©e', 'assigned to you',
                    'assign√© √† vous', 'your task', 'votre t√¢che',
                    
                    // √âch√©ances (unique √† t√¢ches)
                    'deadline', '√©ch√©ance', 'due date', 'date limite',
                    'due by', '√† rendre avant', 'livrable', 'deliverable',
                    
                    // Validation (unique √† t√¢ches)
                    'merci de valider', 'validation requise', 'approval needed',
                    'approbation requise', 'please approve', 'veuillez approuver',
                    
                    // Tags utilisateur (unique √† t√¢ches)
                    '@team', '@tous', '@all', '@urgent'
                ],
                strong: [
                    // Urgence (unique √† t√¢ches)
                    'urgent', 'urgence', 'tr√®s urgent', 'asap', 'priority',
                    'priorit√©', 'prioritaire', 'critique', 'critical',
                    
                    // Actions t√¢ches (unique √† t√¢ches)
                    'task', 't√¢che', 'todo', '√† faire', 'pending',
                    'en attente', 'awaiting', 'correction', 'corriger',
                    'r√©vision', 'review', 'r√©viser', 'valider', 'validate',
                    
                    // Indicateurs de tag
                    'assigner', 'assign', 'attribuer', 'pour toi', 'for you'
                ],
                weak: [
                    'demande', 'request', 'besoin', 'need',
                    'attente', 'waiting', 'response', 'r√©ponse'
                ],
                exclusions: []
            },

            // FINANCE - Mots-cl√©s uniques
            finance: {
                absolute: [
                    // Documents financiers (unique √† finance)
                    'facture', 'invoice', 'invoice number', 'num√©ro de facture',
                    'relev√© bancaire', 'bank statement', 'relev√© de compte',
                    'bulletin de salaire', 'pay stub', 'fiche de paie',
                    
                    // Paiements (unique √† finance)
                    'payment due', '√©ch√©ance paiement', 'paiement d√ª',
                    'payment required', 'paiement requis', 'payment reminder',
                    'rappel de paiement', 'overdue', 'en retard', 'impay√©',
                    
                    // Transactions (unique √† finance)
                    'virement', 'transfer', 'wire transfer', 'virement bancaire',
                    'remboursement', 'refund', 'reimbursement', 'cr√©dit',
                    
                    // Cartes et comptes (unique √† finance)
                    'credit card', 'carte de cr√©dit', 'debit card', 'carte de d√©bit',
                    'bank notification', 'notification bancaire'
                ],
                strong: [
                    // Termes financiers (unique √† finance)
                    'montant', 'amount', 'total', 'price', 'prix',
                    'fiscal', 'bancaire', 'bank', 'finance', 'financial',
                    'euro', 'dollar', 'currency', 'devise', 'payment',
                    'paiement', 'transaction', 'debit', 'credit', 'solde',
                    'balance', 'billing', 'facturation', 'charge', 'frais'
                ],
                weak: [
                    'money', 'argent', 'cost', 'co√ªt', 'fee',
                    'expense', 'd√©pense', 'receipt', 're√ßu'
                ],
                exclusions: []
            },

            // R√âUNIONS - Mots-cl√©s uniques
            meetings: {
                absolute: [
                    // Demandes r√©union (unique √† meetings)
                    'demande de r√©union', 'meeting request', 'r√©union demand√©e',
                    'schedule a meeting', 'planifier une r√©union',
                    'invitation r√©union', 'meeting invitation',
                    
                    // Plateformes r√©union (unique √† meetings)
                    'teams meeting', 'zoom meeting', 'google meet',
                    'skype meeting', 'webex meeting', 'gotomeeting',
                    
                    // Liens r√©union (unique √† meetings)
                    'join the meeting', 'rejoindre la r√©union',
                    'meeting link', 'lien de r√©union', 'meeting url',
                    
                    // Rendez-vous (unique √† meetings)
                    'rendez-vous', 'appointment', 'rdv', 'rdv pr√©vu',
                    'calendar invitation', 'invitation calendrier'
                ],
                strong: [
                    // Termes r√©union (unique √† meetings)
                    'meeting', 'r√©union', 'conference', 'conf√©rence',
                    'call', 'appel', 'webinar', 'webinaire', 's√©minaire',
                    'pr√©sentation', 'presentation', 'session', 's√©ance',
                    
                    // Planning (unique √† meetings)
                    'schedule', 'planifier', 'calendar', 'calendrier',
                    'agenda', 'planning', 'disponibilit√©', 'availability'
                ],
                weak: [
                    'disponible', 'available', 'slot', 'cr√©neau',
                    'time', 'temps', 'date', 'heure', 'dur√©e'
                ],
                exclusions: []
            },

            // COMMERCIAL - Mots-cl√©s uniques
            commercial: {
                absolute: [
                    // Documents commerciaux (unique √† commercial)
                    'devis', 'quotation', 'quote', 'estimation',
                    'proposal', 'proposition', 'proposition commerciale',
                    'business proposal', 'offre commerciale',
                    
                    // Contrats (unique √† commercial)
                    'contrat', 'contract', 'agreement', 'accord',
                    'bon de commande', 'purchase order', 'po number',
                    
                    // Opportunit√©s (unique √† commercial)
                    'opportunity', 'opportunit√©', 'lead', 'prospect qualifi√©',
                    'n√©gociation', 'negotiation', 'closing', 'signature'
                ],
                strong: [
                    // Termes commerciaux (unique √† commercial)
                    'client', 'customer', 'prospect', 'commercial',
                    'business', 'affaires', 'march√©', 'market',
                    'vente', 'sales', 'revenue', 'chiffre d\'affaires',
                    
                    // Relations (unique √† commercial)
                    'partnership', 'partenariat', 'collaboration',
                    'vendor', 'fournisseur', 'supplier', 'distributeur'
                ],
                weak: [
                    'discussion', 'projet', 'project', 'potential',
                    'potentiel', 'interest', 'int√©r√™t', 'besoin client'
                ],
                exclusions: []
            },

            // SUPPORT - Mots-cl√©s uniques
            support: {
                absolute: [
                    // Tickets (unique √† support)
                    'ticket #', 'ticket number', 'num√©ro de ticket',
                    'ticket id', 'case #', 'case number', 'case id',
                    'incident #', 'incident number', 'incident id',
                    
                    // Support (unique √† support)
                    'support ticket', 'demande de support', 'support request',
                    'help desk', 'service desk', 'assistance technique',
                    
                    // R√©solution (unique √† support)
                    'probl√®me r√©solu', 'issue resolved', 'ticket closed',
                    'ticket ferm√©', 'resolution', 'r√©solution'
                ],
                strong: [
                    // Termes support (unique √† support)
                    'support', 'assistance', 'help', 'aide',
                    'technical support', 'support technique',
                    'troubleshooting', 'd√©pannage', 'diagnostic',
                    
                    // Probl√®mes (unique √† support)
                    'probl√®me', 'problem', 'issue', 'incident',
                    'bug', 'd√©faut', 'erreur', 'error', 'panne'
                ],
                weak: [
                    'question', 'solution', 'workaround', 'contournement',
                    'escalation', 'escalade', 'sla', 'service level'
                ],
                exclusions: []
            },

            // RH - Mots-cl√©s uniques
            hr: {
                absolute: [
                    // Documents RH (unique √† hr)
                    'bulletin de paie', 'payslip', 'salary slip',
                    'contrat de travail', 'employment contract',
                    'avenant', 'amendment', 'attestation employeur',
                    
                    // Cong√©s (unique √† hr)
                    'cong√©s', 'leave request', 'vacation request',
                    'absence request', 'demande d\'absence', 'rtt',
                    
                    // Processus RH (unique √† hr)
                    'onboarding', 'int√©gration', 'offboarding',
                    'entretien annuel', 'performance review',
                    '√©valuation annuelle', 'annual review'
                ],
                strong: [
                    // Termes RH (unique √† hr)
                    'rh', 'hr', 'ressources humaines', 'human resources',
                    'salaire', 'salary', 'r√©mun√©ration', 'compensation',
                    'paie', 'payroll', 'benefits', 'avantages sociaux',
                    
                    // Emploi (unique √† hr)
                    'emploi', 'job', 'poste', 'position', 'recrutement',
                    'recruitment', 'hiring', 'embauche', 'formation'
                ],
                weak: [
                    'employee', 'employ√©', 'staff', 'personnel',
                    '√©quipe', 'team', 'department', 'service'
                ],
                exclusions: []
            },

            // RELANCES - Mots-cl√©s uniques
            reminders: {
                absolute: [
                    // Formules relance (unique √† reminders)
                    'reminder:', 'rappel:', 'friendly reminder',
                    'rappel amical', 'gentle reminder', 'petit rappel',
                    
                    // Follow-up (unique √† reminders)
                    'follow up', 'follow-up', 'relance', 'following up',
                    'je reviens vers vous', 'circling back',
                    'comme convenu', 'as discussed', 'as agreed',
                    
                    // Statut (unique √† reminders)
                    'still waiting', 'toujours en attente',
                    'pending response', 'r√©ponse en attente'
                ],
                strong: [
                    // Termes relance (unique √† reminders)
                    'reminder', 'rappel', 'relance', 'suivi',
                    'follow', 'suite √†', 'convenu', 'discussed',
                    'pending', 'en attente', 'outstanding', 'restant'
                ],
                weak: [
                    'previous', 'pr√©c√©dent', 'earlier', 'plus t√¥t',
                    'encore', 'still', 'toujours', 'yet'
                ],
                exclusions: []
            },

            // PROJETS - Mots-cl√©s uniques
            project: {
                absolute: [
                    // Gestion projet (unique √† project)
                    'project update', 'mise √† jour projet',
                    'project status', 'statut projet', 'avancement projet',
                    'project milestone', 'jalon projet', 'milestone',
                    
                    // M√©thodologies (unique √† project)
                    'sprint planning', 'planification sprint',
                    'sprint review', 'retrospective', 'retro',
                    'daily standup', 'standup', 'scrum meeting',
                    
                    // Outils projet (unique √† project)
                    'gantt chart', 'diagramme gantt', 'roadmap',
                    'backlog', 'user story', 'epic', 'jira ticket'
                ],
                strong: [
                    // Termes projet (unique √† project)
                    'projet', 'project', 'sprint', 'iteration',
                    'agile', 'scrum', 'kanban', 'waterfall',
                    
                    // D√©veloppement (unique √† project)
                    'development', 'd√©veloppement', 'release',
                    'deployment', 'd√©ploiement', 'livraison',
                    'testing', 'test', 'qa', 'quality'
                ],
                weak: [
                    'phase', '√©tape', 'stage', 'progress',
                    'progr√®s', 'avancement', 'timeline', 'd√©lai'
                ],
                exclusions: []
            },

            // COMMUNICATION INTERNE - Mots-cl√©s uniques
            internal: {
                absolute: [
                    // Annonces internes (unique √† internal)
                    'all staff', 'tout le personnel', 'all employees',
                    'tous les employ√©s', 'company wide', 'toute l\'entreprise',
                    
                    // Communications officielles (unique √† internal)
                    'annonce interne', 'internal announcement',
                    'company announcement', 'annonce entreprise',
                    'memo interne', 'internal memo', 'note de service',
                    
                    // Distribution (unique √† internal)
                    'communication interne', 'internal communication',
                    '√† tous', 'to all', 'distribution g√©n√©rale'
                ],
                strong: [
                    // Termes internes (unique √† internal)
                    'internal', 'interne', 'company', 'entreprise',
                    'organization', 'organisation', 'corporate',
                    
                    // Types communication (unique √† internal)
                    'annonce', 'announcement', 'memo', 'm√©mo',
                    'policy', 'politique', 'procedure', 'proc√©dure',
                    'directive', 'guideline', 'r√®glement'
                ],
                weak: [
                    'information', 'info', 'update', 'mise √† jour',
                    'news', 'nouvelle', 'changement', 'change'
                ],
                exclusions: []
            },

            // NOTIFICATIONS - Mots-cl√©s uniques
            notifications: {
                absolute: [
                    // Messages automatiques (unique √† notifications)
                    'do not reply', 'ne pas r√©pondre', 'no reply',
                    'automatic reply', 'r√©ponse automatique',
                    'auto-reply', 'auto reply', 'autoreply',
                    
                    // Syst√®me (unique √† notifications)
                    'system notification', 'notification syst√®me',
                    'system alert', 'alerte syst√®me', 'system message',
                    'server notification', 'notification serveur',
                    
                    // Maintenance (unique √† notifications)
                    'maintenance notification', 'notification maintenance',
                    'scheduled maintenance', 'maintenance planifi√©e',
                    'backup notification', 'notification sauvegarde'
                ],
                strong: [
                    // Termes notification (unique √† notifications)
                    'automated', 'automatic', 'automatique', 'automatis√©',
                    'system', 'syst√®me', 'server', 'serveur',
                    'maintenance', 'backup', 'sauvegarde', 'update syst√®me'
                ],
                weak: [
                    'notice', 'avis', 'status', 'statut',
                    'monitoring', 'surveillance', 'log', 'journal'
                ],
                exclusions: []
            },

            // EN COPIE - Mots-cl√©s uniques
            cc: {
                absolute: [
                    // Formules CC (unique √† cc)
                    'copie pour information', 'for your information',
                    'fyi', 'pour info', 'pour information',
                    'en copie', 'in copy', 'cc:', 'courtesy copy',
                    
                    // Visibilit√© (unique √† cc)
                    'shared for visibility', 'partag√© pour visibilit√©',
                    'keeping you in the loop', 'pour vous tenir inform√©',
                    'for awareness', 'pour information seulement'
                ],
                strong: [
                    // Termes CC (unique √† cc)
                    'copie', 'copy', 'cc', 'fyi', 'visibility',
                    'visibilit√©', 'awareness', 'connaissance'
                ],
                weak: [
                    'share', 'partage', 'inform', 'informer'
                ],
                exclusions: []
            }
        };

        console.log('[CategoryManager] ‚úÖ Catalogue initialis√© avec mots-cl√©s uniques par cat√©gorie');
    }

    // ================================================
    // ANALYSE EMAIL - D√âTECTION MOTS-CL√âS AM√âLIOR√âE
    // ================================================
    analyzeEmail(email) {
        if (!email) return { category: 'other', score: 0, confidence: 0 };
        
        if (this.shouldExcludeSpam() && this.isSpamEmail(email)) {
            return { category: 'spam', score: 0, confidence: 0, isSpam: true };
        }
        
        const content = this.extractCompleteContentEnhanced(email);
        
        if (this.isGloballyExcluded(content, email)) {
            return { category: 'excluded', score: 0, confidence: 0, isExcluded: true };
        }
        
        // D√âTECTION PAR TAG (@) - PRIORIT√â ABSOLUE POUR T√ÇCHES
        const tagDetection = this.detectUserTag(content, email);
        if (tagDetection.hasTag) {
            console.log(`[CategoryManager] üë§ TAG D√âTECT√â: @${tagDetection.taggedUser} - Cat√©gorisation automatique en t√¢che`);
            return {
                category: 'tasks',
                score: 500, // Score tr√®s √©lev√© pour priorit√© absolue
                confidence: 0.99,
                matchedPatterns: [{
                    keyword: `@${tagDetection.taggedUser}`,
                    type: 'user_tag',
                    score: 500
                }],
                hasAbsolute: true,
                detectionMethod: 'user_tag',
                taggedUser: tagDetection.taggedUser,
                tagContext: tagDetection.context
            };
        }
        
        const newsletterResult = this.detectNewsletterEnhanced(content, email);
        if (newsletterResult && newsletterResult.score >= 80) {
            return newsletterResult;
        }
        
        const allResults = this.analyzeAllCategories(content, email);
        const selectedResult = this.selectBestCategory(allResults);
        
        // Si aucune cat√©gorie n'est trouv√©e, retourner "other"
        if (!selectedResult || selectedResult.score === 0) {
            return {
                category: 'other',
                score: 0,
                confidence: 0,
                matchedPatterns: [],
                hasAbsolute: false,
                reason: 'no_category_matched',
                detectionMethod: 'default_other'
            };
        }
        
        return selectedResult;
    }

    // ================================================
    // D√âTECTION DES TAGS UTILISATEUR (@)
    // ================================================
    detectUserTag(content, email) {
        const result = {
            hasTag: false,
            taggedUser: null,
            context: null,
            matches: []
        };
        
        // Patterns pour d√©tecter les tags
        // Format: @nom ou @prenom.nom ou @nom-compose
        const tagPattern = /@([a-zA-Z0-9\-_.]+)/g;
        
        // Chercher dans le sujet
        const subjectMatches = email.subject?.match(tagPattern);
        if (subjectMatches && subjectMatches.length > 0) {
            const taggedUser = subjectMatches[0].substring(1); // Enlever le @
            result.hasTag = true;
            result.taggedUser = taggedUser;
            result.context = 'subject';
            result.matches.push({
                tag: subjectMatches[0],
                location: 'subject',
                fullText: email.subject
            });
            return result;
        }
        
        // Chercher dans le corps (d√©but du message)
        if (content.text) {
            // Extraire les 500 premiers caract√®res pour la performance
            const bodyStart = content.text.substring(0, 500);
            const bodyMatches = bodyStart.match(tagPattern);
            
            if (bodyMatches && bodyMatches.length > 0) {
                // V√©rifier que ce n'est pas une adresse email
                const tag = bodyMatches[0];
                const beforeTag = bodyStart.substring(Math.max(0, bodyStart.indexOf(tag) - 1), bodyStart.indexOf(tag));
                
                // Si ce n'est pas pr√©c√©d√© par un caract√®re d'email, c'est un tag valide
                if (beforeTag !== '.' && beforeTag !== '-' && !bodyStart.includes(tag + '@')) {
                    const taggedUser = tag.substring(1);
                    result.hasTag = true;
                    result.taggedUser = taggedUser;
                    result.context = 'body';
                    result.matches.push({
                        tag: tag,
                        location: 'body',
                        snippet: bodyStart.substring(
                            Math.max(0, bodyStart.indexOf(tag) - 30),
                            Math.min(bodyStart.length, bodyStart.indexOf(tag) + 30)
                        )
                    });
                }
            }
        }
        
        // Chercher dans le preview
        if (!result.hasTag && email.bodyPreview) {
            const previewMatches = email.bodyPreview.match(tagPattern);
            if (previewMatches && previewMatches.length > 0) {
                const tag = previewMatches[0];
                const beforeTag = email.bodyPreview.substring(
                    Math.max(0, email.bodyPreview.indexOf(tag) - 1), 
                    email.bodyPreview.indexOf(tag)
                );
                
                if (beforeTag !== '.' && beforeTag !== '-' && !email.bodyPreview.includes(tag + '@')) {
                    const taggedUser = tag.substring(1);
                    result.hasTag = true;
                    result.taggedUser = taggedUser;
                    result.context = 'preview';
                    result.matches.push({
                        tag: tag,
                        location: 'preview',
                        snippet: email.bodyPreview
                    });
                }
            }
        }
        
        return result;
    }

    // ================================================
    // D√âTECTION NEWSLETTER AM√âLIOR√âE
    // ================================================
    detectNewsletterEnhanced(content, email) {
        let totalScore = 0;
        const matches = [];
        let hasStrongIndicator = false;
        
        const marketingKeywords = this.keywordCatalog.marketing_news;
        const bodyAnalysis = this.analyzeKeywordsInContent(content.text, marketingKeywords, 'marketing_news');
        
        totalScore += bodyAnalysis.score;
        matches.push(...bodyAnalysis.matches);
        
        if (bodyAnalysis.hasAbsolute) {
            hasStrongIndicator = true;
        }
        
        const senderAddress = email.from?.emailAddress?.address?.toLowerCase() || '';
        const newsletterAddressPatterns = [
            'noreply', 'no-reply', 'donotreply', 'do-not-reply',
            'notifications', 'updates', 'news', 'newsletter',
            'marketing', 'promo', 'offers', 'deals'
        ];
        
        for (const pattern of newsletterAddressPatterns) {
            if (senderAddress.includes(pattern)) {
                totalScore += 50;
                matches.push({ keyword: `sender_${pattern}`, type: 'sender', score: 50 });
                hasStrongIndicator = true;
                break;
            }
        }
        
        const domain = this.extractDomain(senderAddress);
        const marketingDomains = [
            'mailchimp.com', 'sendgrid.net', 'constantcontact.com',
            'aweber.com', 'getresponse.com', 'campaign-monitor.com'
        ];
        
        if (marketingDomains.some(md => domain.includes(md))) {
            totalScore += 100;
            hasStrongIndicator = true;
            matches.push({ keyword: 'marketing_platform', type: 'domain', score: 100 });
        }
        
        const subjectAnalysis = this.analyzeKeywordsInContent(
            content.subject,
            marketingKeywords,
            'marketing_news',
            2.0
        );
        
        totalScore += subjectAnalysis.score;
        matches.push(...subjectAnalysis.matches.map(m => ({
            ...m,
            keyword: m.keyword + ' (subject)',
            type: 'subject_' + m.type
        })));
        
        if (hasStrongIndicator || totalScore >= 80) {
            const confidence = hasStrongIndicator ? 0.95 : 
                              totalScore >= 150 ? 0.90 : 
                              totalScore >= 100 ? 0.85 : 
                              totalScore >= 80 ? 0.75 : 0.70;
            
            return {
                category: 'marketing_news',
                score: Math.min(totalScore, 300),
                confidence: confidence,
                matchedPatterns: matches,
                hasAbsolute: hasStrongIndicator,
                detectionMethod: 'enhanced_keyword_detection',
                keywordMatches: bodyAnalysis.keywordCount
            };
        }
        
        return null;
    }

    // ================================================
    // ANALYSE DES MOTS-CL√âS DANS LE CONTENU
    // ================================================
    analyzeKeywordsInContent(text, keywords, categoryId, multiplier = 1.0) {
        let score = 0;
        const matches = [];
        let hasAbsolute = false;
        let keywordCount = 0;
        
        if (!text || !keywords) {
            return { score: 0, matches: [], hasAbsolute: false, keywordCount: 0 };
        }
        
        const normalizedText = text.toLowerCase();
        
        if (keywords.absolute && keywords.absolute.length > 0) {
            for (const keyword of keywords.absolute) {
                const occurrences = this.countKeywordOccurrences(normalizedText, keyword);
                if (occurrences > 0) {
                    const keywordScore = 100 * multiplier * Math.min(occurrences, 3);
                    score += keywordScore;
                    hasAbsolute = true;
                    keywordCount += occurrences;
                    matches.push({
                        keyword: keyword,
                        type: 'absolute',
                        score: keywordScore,
                        occurrences: occurrences
                    });
                }
            }
        }
        
        if (keywords.strong && keywords.strong.length > 0) {
            for (const keyword of keywords.strong) {
                const occurrences = this.countKeywordOccurrences(normalizedText, keyword);
                if (occurrences > 0) {
                    const keywordScore = 40 * multiplier * Math.min(occurrences, 2);
                    score += keywordScore;
                    keywordCount += occurrences;
                    matches.push({
                        keyword: keyword,
                        type: 'strong',
                        score: keywordScore,
                        occurrences: occurrences
                    });
                }
            }
        }
        
        if (keywords.weak && keywords.weak.length > 0) {
            for (const keyword of keywords.weak) {
                const occurrences = this.countKeywordOccurrences(normalizedText, keyword);
                if (occurrences > 0) {
                    const keywordScore = 15 * multiplier;
                    score += keywordScore;
                    keywordCount += occurrences;
                    matches.push({
                        keyword: keyword,
                        type: 'weak',
                        score: keywordScore,
                        occurrences: occurrences
                    });
                }
            }
        }
        
        if (keywords.exclusions && keywords.exclusions.length > 0) {
            for (const exclusion of keywords.exclusions) {
                if (this.findKeywordInText(normalizedText, exclusion)) {
                    const penalty = -30 * multiplier;
                    score += penalty;
                    matches.push({
                        keyword: exclusion,
                        type: 'exclusion',
                        score: penalty,
                        occurrences: 1
                    });
                }
            }
        }
        
        return {
            score: Math.max(0, score),
            matches: matches,
            hasAbsolute: hasAbsolute,
            keywordCount: keywordCount
        };
    }

    // ================================================
    // COMPTAGE DES OCCURRENCES DE MOTS-CL√âS
    // ================================================
    countKeywordOccurrences(text, keyword) {
        if (!text || !keyword) return 0;
        
        const normalizedKeyword = keyword.toLowerCase();
        let count = 0;
        let position = 0;
        
        while ((position = text.indexOf(normalizedKeyword, position)) !== -1) {
            count++;
            position += normalizedKeyword.length;
        }
        
        if (count === 0) {
            try {
                const wordBoundaryRegex = new RegExp(`\\b${this.escapeRegex(normalizedKeyword)}\\b`, 'gi');
                const matches = text.match(wordBoundaryRegex);
                if (matches) {
                    count = matches.length;
                }
            } catch (e) {
                // Ignorer les erreurs regex
            }
        }
        
        return count;
    }

    // ================================================
    // RECHERCHE DE MOT-CL√â DANS LE TEXTE
    // ================================================
    findKeywordInText(text, keyword) {
        if (!text || !keyword) return false;
        
        const normalizedKeyword = keyword.toLowerCase();
        
        if (text.includes(normalizedKeyword)) {
            return true;
        }
        
        try {
            const wordBoundaryRegex = new RegExp(`\\b${this.escapeRegex(normalizedKeyword)}\\b`, 'i');
            return wordBoundaryRegex.test(text);
        } catch (e) {
            return false;
        }
    }

    // ================================================
    // ANALYSE DE TOUTES LES CAT√âGORIES
    // ================================================
    analyzeAllCategories(content, email) {
        const results = {};
        const activeCategories = this.getActiveCategories();
        
        for (const categoryId of Object.keys(this.keywordCatalog)) {
            if (!activeCategories.includes(categoryId) && categoryId !== 'cc') {
                continue;
            }
            
            const keywords = this.keywordCatalog[categoryId];
            if (!keywords) continue;
            
            const contentAnalysis = this.analyzeKeywordsInContent(
                content.text,
                keywords,
                categoryId
            );
            
            const subjectAnalysis = this.analyzeKeywordsInContent(
                content.subject,
                keywords,
                categoryId,
                1.5
            );
            
            const totalScore = contentAnalysis.score + subjectAnalysis.score;
            const allMatches = [...contentAnalysis.matches, ...subjectAnalysis.matches];
            const hasAbsolute = contentAnalysis.hasAbsolute || subjectAnalysis.hasAbsolute;
            const totalKeywords = contentAnalysis.keywordCount + subjectAnalysis.keywordCount;
            
            let categoryBonus = 0;
            if (categoryId === 'marketing_news' && totalKeywords > 3) {
                categoryBonus = 50;
            } else if (['security', 'finance', 'tasks'].includes(categoryId) && hasAbsolute) {
                categoryBonus = 30;
            }
            
            const finalScore = totalScore + categoryBonus;
            
            results[categoryId] = {
                category: categoryId,
                score: finalScore,
                confidence: this.calculateConfidence(finalScore, hasAbsolute, totalKeywords),
                matchedPatterns: allMatches,
                hasAbsolute: hasAbsolute,
                keywordCount: totalKeywords,
                priority: this.categories[categoryId]?.priority || 50
            };
        }
        
        if (this.shouldDetectCC() && this.isInCC(email) && !this.isMainRecipient(email)) {
            results.cc = {
                category: 'cc',
                score: 100,
                confidence: 0.95,
                matchedPatterns: [{ keyword: 'in_cc', type: 'detected', score: 100 }],
                hasAbsolute: true,
                priority: 30
            };
        }
        
        return results;
    }

    // ================================================
    // S√âLECTION DE LA MEILLEURE CAT√âGORIE
    // ================================================
    selectBestCategory(results) {
        const MIN_SCORE_THRESHOLD = 20;
        const MIN_CONFIDENCE_THRESHOLD = 0.5;
        
        const validResults = Object.values(results)
            .filter(r => r.score >= MIN_SCORE_THRESHOLD && r.confidence >= MIN_CONFIDENCE_THRESHOLD)
            .sort((a, b) => {
                if (a.hasAbsolute && !b.hasAbsolute) return -1;
                if (!a.hasAbsolute && b.hasAbsolute) return 1;
                
                if (Math.abs(a.score - b.score) > 20) {
                    return b.score - a.score;
                }
                
                if (a.priority !== b.priority) {
                    return b.priority - a.priority;
                }
                
                return (b.keywordCount || 0) - (a.keywordCount || 0);
            });
        
        if (validResults.length === 0) {
            return null;
        }
        
        return validResults[0];
    }

    // ================================================
    // CALCUL DE CONFIDENCE
    // ================================================
    calculateConfidence(score, hasAbsolute, keywordCount = 0) {
        if (hasAbsolute) {
            if (score >= 200) return 0.98;
            if (score >= 150) return 0.95;
            if (score >= 100) return 0.90;
            return 0.85;
        }
        
        if (score >= 150 && keywordCount >= 5) return 0.90;
        if (score >= 100 && keywordCount >= 3) return 0.85;
        if (score >= 80 && keywordCount >= 2) return 0.80;
        if (score >= 60) return 0.75;
        if (score >= 40) return 0.70;
        if (score >= 30) return 0.65;
        if (score >= 20) return 0.60;
        return 0.50;
    }

    // ================================================
    // EXTRACTION DE CONTENU AM√âLIOR√âE
    // ================================================
    extractCompleteContentEnhanced(email) {
        let allText = '';
        let subject = '';
        
        if (email.subject && email.subject.trim()) {
            subject = email.subject;
            allText += (email.subject + ' ').repeat(3);
        } else {
            subject = '[SANS_SUJET]';
            allText += 'sans sujet email sans objet ';
        }
        
        if (email.from?.emailAddress?.address) {
            const senderAddress = email.from.emailAddress.address;
            allText += senderAddress + ' ';
            
            const domain = this.extractDomain(senderAddress);
            allText += domain + ' ';
        }
        
        if (email.from?.emailAddress?.name) {
            const senderName = email.from.emailAddress.name;
            allText += senderName + ' ';
        }
        
        if (email.bodyPreview) {
            const cleanPreview = this.cleanAndNormalizeText(email.bodyPreview);
            allText += (cleanPreview + ' ').repeat(2);
        }
        
        if (email.body?.content) {
            let bodyContent = email.body.content;
            
            if (bodyContent.includes('<')) {
                bodyContent = this.cleanHtmlContent(bodyContent);
            }
            
            const cleanBody = this.cleanAndNormalizeText(bodyContent);
            allText += cleanBody + ' ';
        }
        
        if (email.categories && Array.isArray(email.categories)) {
            email.categories.forEach(cat => {
                allText += cat + ' ';
            });
        }
        
        if (email.importance) {
            allText += email.importance + ' ';
        }
        
        if (email.hasAttachments) {
            allText += 'attachment pi√®ce jointe ';
        }
        
        return {
            text: allText.toLowerCase().trim(),
            subject: subject.toLowerCase(),
            rawSubject: email.subject || '',
            domain: this.extractDomain(email.from?.emailAddress?.address),
            hasHtml: !!(email.body?.content && email.body.content.includes('<')),
            length: allText.length,
            senderAddress: email.from?.emailAddress?.address?.toLowerCase() || '',
            senderName: email.from?.emailAddress?.name?.toLowerCase() || ''
        };
    }

    // ================================================
    // NETTOYAGE HTML
    // ================================================
    cleanHtmlContent(html) {
        if (!html) return '';
        
        let cleaned = html;
        
        cleaned = cleaned.replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, (match, href, text) => {
            return ` ${text} ${href} `;
        });
        
        cleaned = cleaned.replace(/<img[^>]*alt=["']([^"']*)["'][^>]*>/gi, (match, alt) => {
            return ` ${alt} `;
        });
        
        cleaned = cleaned
            .replace(/<style[^>]*>.*?<\/style>/gis, ' ')
            .replace(/<script[^>]*>.*?<\/script>/gis, ' ')
            .replace(/<[^>]+>/g, ' ')
            .replace(/&[^;]+;/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
        
        return cleaned;
    }

    // ================================================
    // NETTOYAGE ET NORMALISATION DU TEXTE
    // ================================================
    cleanAndNormalizeText(text) {
        if (!text) return '';
        
        return text
            .replace(/√É¬©/g, '√©')
            .replace(/√É¬®/g, '√®')
            .replace(/√É /g, '√†')
            .replace(/√É¬¥/g, '√¥')
            .replace(/√É¬ß/g, '√ß')
            .replace(/√É¬π/g, '√π')
            .replace(/√É¬¢/g, '√¢')
            .replace(/√É¬™/g, '√™')
            .replace(/√É¬Æ/g, '√Æ')
            .replace(/√É¬Ø/g, '√Ø')
            .replace(/√É¬´/g, '√´')
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/['']/g, "'")
            .replace(/[-_]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
    }

    // ================================================
    // M√âTHODES UTILITAIRES
    // ================================================
    extractDomain(email) {
        if (!email || !email.includes('@')) return 'unknown';
        return email.split('@')[1]?.toLowerCase() || 'unknown';
    }

    escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ================================================
    // INITIALISATION DES CAT√âGORIES
    // ================================================
    initializeCategories() {
        this.categories = {
            marketing_news: {
                name: 'Marketing & News',
                icon: 'üì∞',
                color: '#8b5cf6',
                description: 'Newsletters, promotions et marketing',
                priority: 100,
                isCustom: false
            },
            security: {
                name: 'S√©curit√©',
                icon: 'üîí',
                color: '#991b1b',
                description: 'Alertes de s√©curit√© et authentification',
                priority: 90,
                isCustom: false
            },
            finance: {
                name: 'Finance',
                icon: 'üí∞',
                color: '#dc2626',
                description: 'Factures et paiements',
                priority: 85,
                isCustom: false
            },
            tasks: {
                name: 'Actions Requises',
                icon: '‚úÖ',
                color: '#ef4444',
                description: 'T√¢ches √† faire, demandes d\'action et messages avec @tags',
                priority: 95, // Priorit√© augment√©e pour les tags
                isCustom: false
            },
            meetings: {
                name: 'R√©unions',
                icon: 'üìÖ',
                color: '#f59e0b',
                description: 'Invitations et demandes de r√©union',
                priority: 70,
                isCustom: false
            },
            commercial: {
                name: 'Commercial',
                icon: 'üíº',
                color: '#059669',
                description: 'Opportunit√©s, devis et contrats',
                priority: 65,
                isCustom: false
            },
            support: {
                name: 'Support',
                icon: 'üõ†Ô∏è',
                color: '#f59e0b',
                description: 'Tickets et assistance',
                priority: 60,
                isCustom: false
            },
            hr: {
                name: 'RH',
                icon: 'üë•',
                color: '#10b981',
                description: 'Ressources humaines',
                priority: 55,
                isCustom: false
            },
            reminders: {
                name: 'Relances',
                icon: 'üîÑ',
                color: '#10b981',
                description: 'Rappels et suivis',
                priority: 50,
                isCustom: false
            },
            project: {
                name: 'Projets',
                icon: 'üìä',
                color: '#3b82f6',
                description: 'Gestion de projet',
                priority: 45,
                isCustom: false
            },
            internal: {
                name: 'Communication Interne',
                icon: 'üì¢',
                color: '#0ea5e9',
                description: 'Annonces internes',
                priority: 40,
                isCustom: false
            },
            cc: {
                name: 'En Copie',
                icon: 'üìã',
                color: '#64748b',
                description: 'Emails o√π vous √™tes en copie',
                priority: 30,
                isCustom: false
            },
            notifications: {
                name: 'Notifications',
                icon: 'üîî',
                color: '#94a3b8',
                description: 'Notifications automatiques syst√®me',
                priority: 20,
                isCustom: false
            },
            other: {
                name: 'Autres',
                icon: 'üìß',
                color: '#6b7280',
                description: 'Emails non cat√©goris√©s',
                priority: 10,
                isCustom: false
            }
        };
        
        console.log('[CategoryManager] üìö Cat√©gories initialis√©es avec cat√©gorie "other"');
    }

    // ================================================
    // D√âTECTION SPAM ET EXCLUSIONS
    // ================================================
    isSpamEmail(email) {
        if (email.parentFolderId) {
            const folderInfo = email.parentFolderId.toLowerCase();
            if (folderInfo.includes('junk') || 
                folderInfo.includes('spam') || 
                folderInfo.includes('unwanted') ||
                folderInfo.includes('ind√©sirable')) {
                return true;
            }
        }
        
        if (email.categories && Array.isArray(email.categories)) {
            const hasSpamCategory = email.categories.some(cat => 
                cat.toLowerCase().includes('spam') ||
                cat.toLowerCase().includes('junk') ||
                cat.toLowerCase().includes('ind√©sirable')
            );
            if (hasSpamCategory) return true;
        }
        
        return false;
    }

    isGloballyExcluded(content, email) {
        const exclusions = this.settings.categoryExclusions;
        if (!exclusions) return false;
        
        if (exclusions.domains && exclusions.domains.length > 0) {
            for (const domain of exclusions.domains) {
                if (content.domain.includes(domain.toLowerCase())) {
                    return true;
                }
            }
        }
        
        if (exclusions.emails && exclusions.emails.length > 0) {
            const emailAddress = email.from?.emailAddress?.address?.toLowerCase();
            if (emailAddress && exclusions.emails.includes(emailAddress)) {
                return true;
            }
        }
        
        return false;
    }

    // ================================================
    // D√âTECTION DESTINATAIRES
    // ================================================
    isMainRecipient(email) {
        if (!email.toRecipients || !Array.isArray(email.toRecipients)) {
            return false;
        }
        
        const currentUserEmail = this.getCurrentUserEmail();
        if (!currentUserEmail) {
            return email.toRecipients.length > 0;
        }
        
        return email.toRecipients.some(recipient => {
            const recipientEmail = recipient.emailAddress?.address?.toLowerCase();
            return recipientEmail === currentUserEmail.toLowerCase();
        });
    }

    isInCC(email) {
        if (!email.ccRecipients || !Array.isArray(email.ccRecipients) || email.ccRecipients.length === 0) {
            return false;
        }
        
        const currentUserEmail = this.getCurrentUserEmail();
        
        if (!currentUserEmail) {
            return false;
        }
        
        const isInToList = email.toRecipients?.some(recipient => {
            const recipientEmail = recipient.emailAddress?.address?.toLowerCase();
            return recipientEmail === currentUserEmail.toLowerCase();
        }) || false;
        
        const isInCCList = email.ccRecipients.some(recipient => {
            const recipientEmail = recipient.emailAddress?.address?.toLowerCase();
            return recipientEmail === currentUserEmail.toLowerCase();
        });
        
        return isInCCList && !isInToList;
    }

    getCurrentUserEmail() {
        try {
            const userInfo = localStorage.getItem('currentUserInfo');
            if (userInfo) {
                const parsed = JSON.parse(userInfo);
                return parsed.email || parsed.userPrincipalName || parsed.mail;
            }
            
            const msalAccounts = JSON.parse(localStorage.getItem('msal.account.keys') || '[]');
            if (msalAccounts.length > 0) {
                const firstAccount = localStorage.getItem(msalAccounts[0]);
                if (firstAccount) {
                    const account = JSON.parse(firstAccount);
                    return account.username || account.preferred_username;
                }
            }
            
            if (window.authService && typeof window.authService.getCurrentUser === 'function') {
                const user = window.authService.getCurrentUser();
                if (user) {
                    return user.email || user.userPrincipalName || user.username;
                }
            }
            
        } catch (e) {
            console.warn('[CategoryManager] Impossible de r√©cup√©rer l\'email utilisateur:', e);
        }
        return null;
    }

    shouldExcludeSpam() {
        return this.settings.preferences?.excludeSpam !== false;
    }

    shouldDetectCC() {
        return this.settings.preferences?.detectCC !== false;
    }

    // ================================================
    // GESTION DES PARAM√àTRES
    // ================================================
    loadSettings() {
        try {
            const saved = localStorage.getItem('categorySettings');
            const defaultSettings = this.getDefaultSettings();
            
            if (saved) {
                const parsedSettings = JSON.parse(saved);
                const mergedSettings = { ...defaultSettings, ...parsedSettings };
                console.log('[CategoryManager] ‚úÖ Settings charg√©s depuis localStorage');
                return mergedSettings;
            } else {
                console.log('[CategoryManager] üìù Utilisation settings par d√©faut');
                return defaultSettings;
            }
        } catch (error) {
            console.error('[CategoryManager] ‚ùå Erreur chargement param√®tres:', error);
            return this.getDefaultSettings();
        }
    }

    getDefaultSettings() {
        return {
            activeCategories: null,
            excludedDomains: [],
            excludedKeywords: [],
            taskPreselectedCategories: ['tasks', 'meetings', 'finance'],
            categoryExclusions: {
                domains: [],
                emails: []
            },
            scanSettings: {
                defaultPeriod: 7,
                defaultFolder: 'inbox',
                autoAnalyze: true,
                autoCategrize: true
            },
            automationSettings: {
                autoCreateTasks: false,
                groupTasksByDomain: false,
                skipDuplicates: true,
                autoAssignPriority: false
            },
            preferences: {
                darkMode: false,
                compactView: false,
                showNotifications: true,
                excludeSpam: true,
                detectCC: true
            }
        };
    }

    saveSettings() {
        try {
            localStorage.setItem('categorySettings', JSON.stringify(this.settings));
            console.log('[CategoryManager] üíæ Settings sauvegard√©s');
        } catch (error) {
            console.error('[CategoryManager] ‚ùå Erreur sauvegarde param√®tres:', error);
        }
    }

    // ================================================
    // D√âTECTION PROVIDERS
    // ================================================
    detectEmailProvider() {
        console.log('[CategoryManager] üîç D√©tection provider email...');
        
        if (window.googleAuthService && 
            typeof window.googleAuthService.isAuthenticated === 'function' && 
            window.googleAuthService.isAuthenticated()) {
            console.log('[CategoryManager] ‚úÖ Gmail d√©tect√© et authentifi√©');
            return {
                type: 'gmail',
                service: window.googleAuthService,
                ...this.scanProviders.gmail
            };
        }
        
        if (window.authService && 
            typeof window.authService.isAuthenticated === 'function' && 
            window.authService.isAuthenticated()) {
            console.log('[CategoryManager] ‚úÖ Outlook d√©tect√© et authentifi√©');
            return {
                type: 'outlook',
                service: window.authService,
                ...this.scanProviders.outlook
            };
        }
        
        console.log('[CategoryManager] ‚ö†Ô∏è Aucun provider email authentifi√©');
        return null;
    }

    checkEmailRetrievalMethods() {
        const provider = this.detectEmailProvider();
        if (!provider) {
            return {
                available: false,
                provider: null,
                methods: [],
                error: 'Aucun provider authentifi√©'
            };
        }

        const availableMethods = [];
        
        if (window.mailService && typeof window.mailService.getEmailsFromFolder === 'function') {
            availableMethods.push('mailService');
        }
        
        if (provider.type === 'gmail') {
            if (window.googleAuthService && typeof window.googleAuthService.getAccessToken === 'function') {
                availableMethods.push('directGmail');
            }
        } else if (provider.type === 'outlook') {
            if (window.authService && typeof window.authService.getAccessToken === 'function') {
                availableMethods.push('directOutlook');
            }
        }

        return {
            available: availableMethods.length > 0,
            provider: provider,
            methods: availableMethods,
            error: availableMethods.length === 0 ? 'Aucune m√©thode de r√©cup√©ration disponible' : null
        };
    }

    // ================================================
    // API PUBLIQUE
    // ================================================
    getSettings() {
        return JSON.parse(JSON.stringify(this.settings));
    }

    getTaskPreselectedCategories() {
        return [...(this.settings.taskPreselectedCategories || [])];
    }

    updateTaskPreselectedCategories(categories) {
        console.log('[CategoryManager] üìã updateTaskPreselectedCategories:', categories);
        
        const normalizedCategories = Array.isArray(categories) ? [...categories] : [];
        this.settings.taskPreselectedCategories = normalizedCategories;
        this.saveSettings();
        
        this.notifyChange('taskPreselectedCategories', normalizedCategories);
        
        return normalizedCategories;
    }

    getActiveCategories() {
        if (!this.settings.activeCategories) {
            const allCategories = [...Object.keys(this.categories), ...Object.keys(this.customCategories)];
            return allCategories;
        }
        
        return [...this.settings.activeCategories];
    }

    getCategories() {
        return { ...this.categories, ...this.customCategories };
    }

    getCategory(categoryId) {
        if (categoryId === 'all') {
            return { id: 'all', name: 'Tous', icon: 'üìß', color: '#1e293b' };
        }
        if (categoryId === 'other') {
            return { id: 'other', name: 'Non class√©', icon: '‚ùì', color: '#64748b' };
        }
        if (categoryId === 'spam') {
            return { id: 'spam', name: 'Spam', icon: 'üö´', color: '#dc2626' };
        }
        if (categoryId === 'excluded') {
            return { id: 'excluded', name: 'Exclu', icon: 'üö´', color: '#6b7280' };
        }
        return this.categories[categoryId] || this.customCategories[categoryId] || null;
    }

    // ================================================
    // GESTION SCAN ET HISTORIQUE
    // ================================================
    recordScanResult(scanResult) {
        const record = {
            timestamp: Date.now(),
            provider: scanResult.provider || 'unknown',
            totalEmails: scanResult.total || 0,
            categorizedEmails: scanResult.categorized || 0,
            preselectedForTasks: scanResult.stats?.preselectedForTasks || 0,
            marketingDetected: scanResult.stats?.marketingDetected || 0,
            scanDuration: scanResult.stats?.scanDuration || 0,
            breakdown: scanResult.breakdown || {},
            taskPreselectedCategories: scanResult.taskPreselectedCategories || []
        };

        this.scanHistory.push(record);
        this.lastScanResults = record;

        if (this.scanHistory.length > 10) {
            this.scanHistory = this.scanHistory.slice(-10);
        }

        console.log('[CategoryManager] üìä Scan enregistr√©:', record);
        this.notifyChange('scanCompleted', record);
    }

    getScanHistory() {
        return [...this.scanHistory];
    }

    getLastScanResults() {
        return this.lastScanResults;
    }

    // ================================================
    // CAT√âGORIES PERSONNALIS√âES
    // ================================================
    loadCustomCategories() {
        try {
            const saved = localStorage.getItem('customCategories');
            this.customCategories = saved ? JSON.parse(saved) : {};
            
            console.log('[CategoryManager] üìÅ Chargement cat√©gories personnalis√©es...');
            
            Object.entries(this.customCategories).forEach(([id, category]) => {
                this.categories[id] = {
                    ...category,
                    isCustom: true,
                    priority: category.priority || 30
                };
                
                if (category.keywords) {
                    this.keywordCatalog[id] = {
                        absolute: [...(category.keywords.absolute || [])],
                        strong: [...(category.keywords.strong || [])],
                        weak: [...(category.keywords.weak || [])],
                        exclusions: [...(category.keywords.exclusions || [])]
                    };
                }
                
                console.log(`[CategoryManager] ‚úÖ Cat√©gorie personnalis√©e "${category.name}" charg√©e`);
            });
            
            console.log('[CategoryManager] üìä Total:', Object.keys(this.customCategories).length, 'cat√©gories personnalis√©es');
            
        } catch (error) {
            console.error('[CategoryManager] ‚ùå Erreur chargement cat√©gories personnalis√©es:', error);
            this.customCategories = {};
        }
    }

    // ================================================
    // GESTION √âV√âNEMENTS
    // ================================================
    setupEventListeners() {
        window.addEventListener('storage', (e) => {
            if (e.key === 'categorySettings') {
                console.log('[CategoryManager] üîÑ Changement localStorage d√©tect√©');
                this.reloadSettingsFromStorage();
            }
        });
    }

    reloadSettingsFromStorage() {
        const oldSettings = { ...this.settings };
        this.settings = this.loadSettings();
        
        const changes = this.detectSettingsChanges(oldSettings, this.settings);
        changes.forEach(change => {
            this.notifyChange(change.type, change.value);
        });
    }

    detectSettingsChanges(oldSettings, newSettings) {
        const changes = [];
        
        const criticalFields = [
            'taskPreselectedCategories',
            'activeCategories', 
            'categoryExclusions',
            'scanSettings',
            'automationSettings',
            'preferences'
        ];
        
        criticalFields.forEach(field => {
            const oldValue = JSON.stringify(oldSettings[field] || {});
            const newValue = JSON.stringify(newSettings[field] || {});
            
            if (oldValue !== newValue) {
                changes.push({
                    type: field,
                    value: newSettings[field],
                    oldValue: oldSettings[field]
                });
            }
        });
        
        return changes;
    }

    addChangeListener(callback) {
        this.changeListeners.add(callback);
        console.log(`[CategoryManager] üëÇ Listener ajout√© (${this.changeListeners.size} total)`);
        
        return () => {
            this.changeListeners.delete(callback);
        };
    }

    notifyChange(type, value) {
        console.log(`[CategoryManager] üì¢ Notification changement: ${type}`);
        
        this.changeListeners.forEach(listener => {
            try {
                listener(type, value, this.settings);
            } catch (error) {
                console.error('[CategoryManager] Erreur listener:', error);
            }
        });
        
        setTimeout(() => {
            this.dispatchEvent('categorySettingsChanged', { 
                settings: this.settings,
                type,
                value,
                timestamp: Date.now()
            });
            
            this.dispatchEvent('settingsChanged', { 
                type, 
                value,
                source: 'CategoryManager',
                timestamp: Date.now()
            });
        }, 10);
    }

    dispatchEvent(eventName, detail) {
        try {
            window.dispatchEvent(new CustomEvent(eventName, { 
                detail: {
                    ...detail,
                    source: 'CategoryManager',
                    timestamp: Date.now()
                }
            }));
        } catch (error) {
            console.error(`[CategoryManager] Erreur dispatch ${eventName}:`, error);
        }
    }

    // ================================================
    // M√âTHODES DE TEST
    // ================================================
    testEmail(subject, body = '', from = 'test@example.com', expectedCategory = null) {
        const testEmail = {
            subject: subject,
            body: { content: body },
            bodyPreview: body.substring(0, 100),
            from: { emailAddress: { address: from } },
            toRecipients: [{ emailAddress: { address: 'user@example.com' } }],
            receivedDateTime: new Date().toISOString()
        };
        
        const result = this.analyzeEmail(testEmail);
        
        console.log('\n[CategoryManager] TEST RESULT v27.1:');
        console.log(`Subject: "${subject}"`);
        console.log(`From: ${from}`);
        console.log(`Category: ${result.category} (expected: ${expectedCategory || 'any'})`);
        console.log(`Score: ${result.score}pts`);
        console.log(`Confidence: ${Math.round(result.confidence * 100)}%`);
        console.log(`Detection Method:`, result.detectionMethod || 'keyword_matching');
        if (result.taggedUser) {
            console.log(`Tagged User: @${result.taggedUser}`);
        }
        console.log(`Keywords matched: ${result.keywordMatches || result.matchedPatterns?.length || 0}`);
        
        if (expectedCategory && result.category !== expectedCategory) {
            console.log(`‚ùå FAILED - Expected ${expectedCategory}, got ${result.category}`);
        } else {
            console.log('‚úÖ SUCCESS');
        }
        
        return result;
    }

    runDiagnostics() {
        console.group('üè• DIAGNOSTIC CategoryManager v27.1');
        
        console.group('üìÇ Cat√©gories');
        const allCategories = Object.keys(this.categories);
        console.log('Total cat√©gories:', allCategories.length);
        console.log('Cat√©gorie "other" pr√©sente:', this.categories.other ? '‚úÖ' : '‚ùå');
        console.log('Support des tags (@):', '‚úÖ');
        console.groupEnd();
        
        console.group('üîç Catalogue mots-cl√©s');
        Object.entries(this.keywordCatalog).forEach(([catId, keywords]) => {
            const total = (keywords.absolute?.length || 0) + 
                         (keywords.strong?.length || 0) + 
                         (keywords.weak?.length || 0);
            const category = this.getCategory(catId);
            console.log(`${category?.icon || 'üìÇ'} ${category?.name || catId}: ${total} mots-cl√©s`);
        });
        console.groupEnd();
        
        console.group('‚ú® Fonctionnalit√©s');
        console.log('D√©tection par tags (@):', '‚úÖ Activ√©e');
        console.log('Cat√©gorie "other" par d√©faut:', '‚úÖ Activ√©e');
        console.log('Mots-cl√©s uniques par cat√©gorie:', '‚úÖ');
        console.groupEnd();
        
        console.groupEnd();
        
        return {
            version: 'v27.1',
            categoriesCount: allCategories.length,
            hasOtherCategory: !!this.categories.other,
            hasTagDetection: true,
            isInitialized: this.isInitialized
        };
    }

    // ================================================
    // NETTOYAGE ET DESTRUCTION
    // ================================================
    cleanup() {
        console.log('[CategoryManager] üßπ Nettoyage...');
        this.changeListeners.clear();
        this.scanHistory = [];
        this.lastScanResults = null;
    }

    destroy() {
        this.cleanup();
        this.categories = {};
        this.keywordCatalog = {};
        this.customCategories = {};
        this.settings = {};
        console.log('[CategoryManager] üí• Instance d√©truite');
    }
}

// ================================================
// INITIALISATION GLOBALE
// ================================================
if (window.categoryManager) {
    console.log('[CategoryManager] üîÑ Nettoyage ancienne instance...');
    try {
        window.categoryManager.destroy?.();
    } catch (e) {
        console.warn('[CategoryManager] Erreur nettoyage:', e);
    }
}

console.log('[CategoryManager] üöÄ Cr√©ation nouvelle instance v27.1...');

try {
    window.categoryManager = new CategoryManager();
    console.log('[CategoryManager] ‚úÖ Instance cr√©√©e avec succ√®s');
} catch (error) {
    console.error('[CategoryManager] ‚ùå Erreur cr√©ation instance:', error);
    
    window.dispatchEvent(new CustomEvent('categoryManagerReady', {
        detail: {
            isInitialized: false,
            error: error.message,
            version: '27.1'
        }
    }));
}

// ================================================
// FONCTIONS DE TEST GLOBALES
// ================================================
window.testCategoryManagerV27 = function() {
    console.group('üß™ TEST CategoryManager v27.1 - Tags et cat√©gorie Other');
    
    const tests = [
        // Tests avec tags
        {
            subject: "@jean peux-tu regarder √ßa ?",
            body: "J'ai besoin de ton avis sur ce document.",
            from: "colleague@company.com",
            expected: "tasks"
        },
        {
            subject: "Rapport mensuel",
            body: "@marie voici le rapport que tu m'as demand√©. Peux-tu le valider ?",
            from: "team@company.com",
            expected: "tasks"
        },
        {
            subject: "Email test",
            body: "Cliquez ici pour vous d√©sabonner de notre newsletter. View in browser.",
            from: "info@company.com",
            expected: "marketing_news"
        },
        {
            subject: "Email important",
            body: "Action requise: veuillez compl√©ter cette t√¢che avant la deadline.",
            from: "manager@company.com",
            expected: "tasks"
        },
        {
            subject: "Document",
            body: "Votre facture est disponible. Montant total: 500‚Ç¨. Paiement requis.",
            from: "billing@company.com",
            expected: "finance"
        },
        {
            subject: "Notification",
            body: "Code de v√©rification: 123456. Nouvelle connexion d√©tect√©e sur votre compte.",
            from: "security@bank.com",
            expected: "security"
        },
        {
            subject: "Message g√©n√©ral",
            body: "Bonjour, j'esp√®re que vous allez bien. Cordialement.",
            from: "contact@example.com",
            expected: "other"
        },
        {
            subject: "Simple email",
            body: "Merci pour votre message. Bonne journ√©e.",
            from: "info@test.com",
            expected: "other"
        }
    ];
    
    tests.forEach(test => {
        window.categoryManager.testEmail(test.subject, test.body, test.from, test.expected);
    });
    
    console.groupEnd();
    
    const diagnostic = window.categoryManager.runDiagnostics();
    return { 
        success: true, 
        testsRun: tests.length,
        diagnostic: diagnostic
    };
};

console.log('‚úÖ CategoryManager v27.1 loaded - Avec d√©tection @tags et cat√©gorie Other');
console.log('üìß Utilisez testCategoryManagerV27() pour tester la d√©tection');
console.log('üë§ Les emails avec @nom seront automatiquement cat√©goris√©s comme t√¢ches');
console.log('üìÇ Les emails non cat√©goris√©s iront dans "Autres"');
